<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xiaozhiyh.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://xiaozhiyh.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Stephen Jiang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://xiaozhiyh.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://xiaozhiyh.github.io/2020/05/22/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Stephen Jiang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/22/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">springboot可执行jar包及依赖jar包打包总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-22 06:59:08 / Modified: 20:26:00" itemprop="dateCreated datePublished" datetime="2020-05-22T06:59:08+08:00">2020-05-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<ul>
<li><p>作者：Stephen jiang</p>
</li>
<li><p>日期：2018-02-22</p>
</li>
<li><p>版本：1.0.0</p>
</li>
<li><p>前情提要：独立计费使用Springboot打成jar（com.anjubao.charge.indie）包提供给安卓端依赖调用，在安卓端需要使用jar，但是安卓端未使用spring框架和maven的情况，在每次发布时自动打包成一个或多个整体，引入打包后的jar之后可直接进行调用，而不用每次都要拷贝所有的jar或单独将jar提交到SVN或GIT上。</p>
</li>
<li><p>最终结果：查询了官方文档以及很多文献之后，使用了maven-assembly-plugin实现了此功能。</p>
</li>
</ul>
</blockquote>
<h3 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h3><h4 id="1、参考文献："><a href="#1、参考文献：" class="headerlink" title="1、参考文献："></a>1、参考文献：</h4><p><a href="https://segmentfault.com/a/1190000010062858" target="_blank" rel="noopener">maven-将依赖的 jar包一起打包到项目 jar 包中</a></p>
<p>其他尝试的参考文献</p>
<p><a href="http://www.voidcn.com/article/p-sclzccjl-bpn.html" target="_blank" rel="noopener">Spring Boot 将第三方依赖和配置文件打包在jar外部并引用</a></p>
<p><a href="https://docs.spring.io/spring-boot/docs/2.0.9.BUILD-SNAPSHOT/reference/htmlsingle/#howto-create-an-additional-executable-jar" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/2.0.9.BUILD-SNAPSHOT/reference/htmlsingle/#howto-create-an-additional-executable-jar</a></p>
<p><a href="https://blog.csdn.net/weixin_38187317/article/details/82688906" target="_blank" rel="noopener">制作SpringBoot的jar给其他项目使用</a></p>
<p><a href="https://www.zybuluo.com/xiaoxiaowang/note/764236" target="_blank" rel="noopener">Maven系列(七)assembly打包-程序和依赖jar包分开化</a></p>
<p><a href="https://blog.csdn.net/guduyishuai/article/details/60968728" target="_blank" rel="noopener">聚合maven+spring-boot打包可执行jar</a></p>
<p><a href="https://zhangjava.coding.me/springboot%E5%B0%86%E9%A1%B9%E7%9B%AE%E4%B8%8E%E4%BE%9D%E8%B5%96%E5%88%86%E5%BC%80%E6%89%93%E5%8C%85/" target="_blank" rel="noopener">springboot将项目与依赖分开打包</a></p>
<p><a href="https://blog.csdn.net/didi7696/article/details/83276770" target="_blank" rel="noopener">用SpringBoot提供一个jar包给别人调用</a></p>
<p><a href="https://www.cnblogs.com/xiaosiyuan/p/6894766.html" target="_blank" rel="noopener">springboot解决第三方依赖jar包的问题</a></p>
<p><a href="https://liaorui.github.io/2018/02/25/Spring-Boot%E9%A1%B9%E7%9B%AEmaven%E6%89%93%E5%8C%85%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">Spring Boot项目maven打包方式总结</a></p>
<p><a href="https://www.cnblogs.com/sxdcgaq8080/p/7727249.html" target="_blank" rel="noopener"><a href="https://www.cnblogs.com/sxdcgaq8080/p/7712874.html" target="_blank" rel="noopener">spring boot 创建web项目并使用jsp作前台页面</a></a></p>
<p><a href="https://blog.csdn.net/csdn2193714269/article/details/78391274" target="_blank" rel="noopener">Springboot中如何引入本地jar包，并通过maven把项目成功打包成jar包部署</a></p>
<h4 id="2、打包参考"><a href="#2、打包参考" class="headerlink" title="2、打包参考"></a>2、打包参考</h4><ul>
<li>可执行包中的第2点<a href="https://segmentfault.com/a/1190000010062858" target="_blank" rel="noopener">maven-将依赖的 jar包一起打包到项目 jar 包中</a></li>
<li>依赖包中的第4点参考了<a href="https://segmentfault.com/a/1190000010062858" target="_blank" rel="noopener">maven-将依赖的 jar包一起打包到项目 jar 包中</a></li>
</ul>
<h3 id="一、可执行包"><a href="#一、可执行包" class="headerlink" title="一、可执行包"></a>一、可执行包</h3><h4 id="1、普通的可执行包（1个包）"><a href="#1、普通的可执行包（1个包）" class="headerlink" title="1、普通的可执行包（1个包）"></a>1、普通的可执行包（1个包）</h4><p>效果如图</p>
<p><img src="/../../images/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/1550821334997.png" alt="1550821334997"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h4 id="2、打包为可执行包和依赖包"><a href="#2、打包为可执行包和依赖包" class="headerlink" title="2、打包为可执行包和依赖包"></a>2、打包为可执行包和依赖包</h4><p>效果如图</p>
<p><img src="/../../images/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/1550821252091.png" alt="1550821252091"></p>
<p>以…exec.jar结尾的为可执行包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span> spring-boot-maven-plugin <span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>





<h3 id="二、依赖包"><a href="#二、依赖包" class="headerlink" title="二、依赖包"></a>二、依赖包</h3><h4 id="1、不含资源的依赖包"><a href="#1、不含资源的依赖包" class="headerlink" title="1、不含资源的依赖包"></a>1、不含资源的依赖包</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>--&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h4 id="2、含资源的依赖包（依赖包另外打包）"><a href="#2、含资源的依赖包（依赖包另外打包）" class="headerlink" title="2、含资源的依赖包（依赖包另外打包）"></a>2、含资源的依赖包（依赖包另外打包）</h4><p>如图示</p>
<p><img src="/../../images/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/1550821617768.png" alt="1550821617768"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                            $&#123;project.build.directory&#125;/lib</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteReleases</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteReleases</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteSnapshots</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteSnapshots</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteIfNewer</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overWriteIfNewer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>--&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.anjubao.charge.indie.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly-package<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">                    <span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly-deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">                    <span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h4 id="3、依赖包打包在本地-第一种配置一"><a href="#3、依赖包打包在本地-第一种配置一" class="headerlink" title="3、依赖包打包在本地(第一种配置一)"></a>3、依赖包打包在本地(第一种配置一)</h4><p>如图，lib为打包后发布的目录</p>
<p><img src="/../../images/springboot%E5%8F%AF%E6%89%A7%E8%A1%8Cjar%E5%8C%85%E5%8F%8A%E4%BE%9D%E8%B5%96jar%E5%8C%85%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/1550821648234.png" alt="1550821648234"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.anjubao.charge.indie.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteReleases</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteReleases</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteSnapshots</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteSnapshots</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">overWriteIfNewer</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overWriteIfNewer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="4、依赖包打包在本地-第二种配置"><a href="#4、依赖包打包在本地-第二种配置" class="headerlink" title="4、依赖包打包在本地(第二种配置)"></a>4、依赖包打包在本地(第二种配置)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overWriteReleases</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteReleases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overWriteSnapshots</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteSnapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overWriteIfNewer</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overWriteIfNewer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="三、完整xml内容"><a href="#三、完整xml内容" class="headerlink" title="三、完整xml内容"></a>三、完整xml内容</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.anjubao.charge.indie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.anjubao.charge.indie<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>com.anjubao.charge.indie<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>chargeApi project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>local nexus server<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.xxx.xxx.92:8081/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 获取maven中的版本号 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.anjubao.charge.indie.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly-package<span class="tag">&lt;/<span class="name">id</span>&gt;</span> <span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span> <span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly-deploy<span class="tag">&lt;/<span class="name">id</span>&gt;</span> <span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">phase</span>&gt;</span> <span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>anjubao Nexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.xxx.xxx.92:8081/nexus/content/repositories/releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>anjubaoNexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.xxx.xxx.92:8081/nexus/content/repositories/snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="四、Springboot官方文档中关于依赖打包的说明"><a href="#四、Springboot官方文档中关于依赖打包的说明" class="headerlink" title="四、Springboot官方文档中关于依赖打包的说明"></a>四、Springboot官方文档中关于依赖打包的说明</h3><p>原文：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Like a war file, a Spring Boot application is not intended to be used as a dependency. If your application contains classes that you want to share with other projects, the recommended approach is to move that code into a separate module. The separate module can then be depended upon by your application and other projects.</span><br><span class="line"></span><br><span class="line">If you cannot rearrange your code as recommended above, Spring Boot’s Maven and Gradle plugins must be configured to produce a separate artifact that is suitable for use as a dependency. The executable archive cannot be used as a dependency as the executable jar format packages application classes in BOOT-INF/classes. This means that they cannot be found when the executable jar is used as a dependency.</span><br><span class="line"></span><br><span class="line">To produce the two artifacts, one that can be used as a dependency and one that is executable, a classifier must be specified. This classifier is applied to the name of the executable archive, leaving the default archive for use as a dependency.</span><br><span class="line"></span><br><span class="line">To configure a classifier of exec in Maven, you can use the following configuration:</span><br></pre></td></tr></table></figure>

<p>中文描述如下：</p>
<p>88.5使用Spring Boot应用程序作为依赖项</p>
<p>与war文件一样，Spring Boot应用程序不能用作依赖项。如果您的应用程序包含要与其他项目共享的类，建议的方法是将该代码移动到单独的模块中。然后，您的应用程序和其他项目可以依赖单独的模块。</p>
<p>如果您不能按照上面的建议重新安排代码，则必须配置Spring Boot的Maven和Gradle插件，以生成适合用作依赖项的单独工件。可执行存档不能用作依赖项，因为 <a href="https://docs.spring.io/spring-boot/docs/2.0.9.BUILD-SNAPSHOT/reference/htmlsingle/#executable-jar-jar-file-structure" target="_blank" rel="noopener">可执行jar格式</a>打包应用程序类<code>BOOT-INF/classes</code>。这意味着当可执行jar用作依赖项时，无法找到它们。</p>
<p>要生成两个工件，一个可以用作依赖项，另一个可执行，必须指定一个分类器。此分类器应用于可执行归档的名称，保留默认归档以用作依赖项。</p>
<p>要<code>exec</code>在Maven中配置分类器，可以使用以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span> </span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span> </span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span> org.springframework.boot <span class="tag">&lt;/ <span class="attr">groupId</span>&gt;</span> </span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span> spring-boot-maven-plugin <span class="tag">&lt;/ <span class="attr">artifactId</span>&gt;</span> </span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span> </span><br><span class="line">				<span class="tag">&lt;<span class="name">classifier</span>&gt;</span> exec <span class="tag">&lt;/ <span class="attr">classifier</span>&gt;</span> </span><br><span class="line">			<span class="tag">&lt;/ <span class="attr">configuration</span>&gt;</span> </span><br><span class="line">		<span class="tag">&lt;/ <span class="attr">plugin</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/ <span class="attr">plugins</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/ <span class="attr">build</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://xiaozhiyh.github.io/2020/05/22/redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Stephen Jiang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/22/redis/" class="post-title-link" itemprop="url">redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-22 01:32:27 / Modified: 20:10:38" itemprop="dateCreated datePublished" datetime="2020-05-22T01:32:27+08:00">2020-05-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、redis是什么"><a href="#一、redis是什么" class="headerlink" title="一、redis是什么"></a>一、redis是什么</h2><p>基于键值对存储的高效率存储，键值对不同数据类型进行储存。</p>
<p>相比较Memcached则是基于一个存储键/值对的[hashmap]。</p>
<h2 id="二、redis的优势"><a href="#二、redis的优势" class="headerlink" title="二、redis的优势"></a>二、redis的优势</h2><h3 id="1、数据结构"><a href="#1、数据结构" class="headerlink" title="1、数据结构"></a>1、数据结构</h3><p>字符类型（String）、散列类型（hash）、列表类型（list）、集合类型（set）、有序集合（sorted-set）</p>
<h3 id="2、功能："><a href="#2、功能：" class="headerlink" title="2、功能："></a>2、功能：</h3><p>1）、可以为每个key设置超时时间</p>
<p>2）、可以通过列表类型来实现分布式队列的操作</p>
<p>3）、支持发布订阅的消息模式 </p>
<h3 id="3、简单："><a href="#3、简单：" class="headerlink" title="3、简单："></a>3、简单：</h3><p>1）、提供了很多命令与redis进行交互，官网大概有100多个命令</p>
<h3 id="4、应用场景"><a href="#4、应用场景" class="headerlink" title="4、应用场景"></a>4、应用场景</h3><p>1）、数据缓存（商品数据、新闻、热点数据）</p>
<p>典型应用场景：redis作为缓存层，mysql作为存储层，绝大部分请求数据都是从redis获取，由于redis具有高并发的特性，所以缓存通常能起到加速读写和降低后端压力的作用。命中缓存后则从缓存中取数据，未命中则查询数据库，数据库的内容实时在缓存中更新。</p>
<p>2）、单点登录（通过一个jar【tomcat-redis-session、jedis、commons-pool】包去重写tomcat的session实现，去实现tomcat的session共享）（字符类型）</p>
<p>redis将用户的session进行集中管理，如果没有获取到redis中的用户信息，需要从mysql中进行获取，并将结果写入到redis，添加1小时（3600s）过期时间</p>
<p>3）、秒杀、抢购、视频播放次数（字符类型）</p>
<p>快速计数、查询缓存</p>
<p>视频播放次数，用户每播放一次，视频播放数自增1。</p>
<p>秒杀、抢购，视频自减一。</p>
<p>实际业务需考虑更多：如视频播放防止作弊、不同维度的累计、数据持久化到底层数据源。秒杀先后顺序等。</p>
<p>4）、网站访问排名（通过有序集合）</p>
<p>5）、应用模块的开发</p>
<p>关注、被关注、好友关系</p>
<p>6）、分布式锁、分布式队列</p>
<p>7）、限速（字符类型）</p>
<p>手机验证码，避免短信接口不被频繁访问，限制用户每分钟获取验证码的频率。</p>
<p>12306抢票：限制IP地址不能在1秒之内访问n次</p>
<h2 id="三、redis安装"><a href="#三、redis安装" class="headerlink" title="三、redis安装"></a>三、redis安装</h2><h3 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h3><p>官网页面：<a href="https://redis.io/download" target="_blank" rel="noopener">https://redis.io/download</a></p>
<p>资源地址：<a href="http://download.redis.io/releases/" target="_blank" rel="noopener">http://download.redis.io/releases/</a></p>
<p>或使用在线下载命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-3.2.11.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="2-解压"><a href="#2-解压" class="headerlink" title="2.解压"></a>2.解压</h3><p>tar -zxvf redis-3.2.11.tar.gz</p>
<h3 id="3-编译"><a href="#3-编译" class="headerlink" title="3.编译"></a>3.编译</h3><p>在redis目录下cd redis-3.2.11执行 make操作</p>
<h3 id="4-编译报错解决"><a href="#4-编译报错解决" class="headerlink" title="4.编译报错解决"></a>4.编译报错解决</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cd src &amp;&amp; make all</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">`/stephen/data/program/redis-3.2.11/src'</span></span><br><span class="line"><span class="string">rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-rdb redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html</span></span><br><span class="line"><span class="string">(cd ../deps &amp;&amp; make distclean)</span></span><br><span class="line"><span class="string">make[2]: Entering directory `</span>/stephen/data/program/redis-<span class="number">3.2</span>.<span class="number">11</span>/deps<span class="string">'</span></span><br><span class="line"><span class="string">(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd lua &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd geohash-int &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(rm -f .make-*)</span></span><br><span class="line"><span class="string">make[2]: Leaving directory `/stephen/data/program/redis-3.2.11/deps'</span></span><br><span class="line">(rm -f .make-*)</span><br><span class="line">echo STD=-std=c99 -pedantic -DREDIS_STATIC=<span class="string">''</span> &gt;&gt; .make-settings</span><br><span class="line">echo WARN=-Wall -W &gt;&gt; .make-settings</span><br><span class="line">echo OPT=-O2 &gt;&gt; .make-settings</span><br><span class="line">echo MALLOC=jemalloc &gt;&gt; .make-settings</span><br><span class="line">echo CFLAGS= &gt;&gt; .make-settings</span><br><span class="line">echo LDFLAGS= &gt;&gt; .make-settings</span><br><span class="line">echo REDIS_CFLAGS= &gt;&gt; .make-settings</span><br><span class="line">echo REDIS_LDFLAGS= &gt;&gt; .make-settings</span><br><span class="line">echo PREV_FINAL_CFLAGS=-std=c99 -pedantic -DREDIS_STATIC=<span class="string">''</span> -Wall -W -O2 -g -ggdb   -I../deps/geohash-<span class="keyword">int</span> -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -DUSE_JEMALLOC -I../deps/jemalloc/include &gt;&gt; .make-settings</span><br><span class="line">echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic &gt;&gt; .make-settings</span><br><span class="line">(cd ../deps &amp;&amp; make hiredis linenoise lua geohash-<span class="keyword">int</span> jemalloc)</span><br><span class="line">make[<span class="number">2</span>]: Entering directory <span class="string">`/stephen/data/program/redis-3.2.11/deps'</span></span><br><span class="line"><span class="string">(cd hiredis &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd linenoise &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd lua &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd geohash-int &amp;&amp; make clean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(cd jemalloc &amp;&amp; [ -f Makefile ] &amp;&amp; make distclean) &gt; /dev/null || true</span></span><br><span class="line"><span class="string">(rm -f .make-*)</span></span><br><span class="line"><span class="string">(echo "" &gt; .make-cflags)</span></span><br><span class="line"><span class="string">(echo "" &gt; .make-ldflags)</span></span><br><span class="line"><span class="string">MAKE hiredis</span></span><br><span class="line"><span class="string">cd hiredis &amp;&amp; make static</span></span><br><span class="line"><span class="string">make[3]: Entering directory `</span>/stephen/data/program/redis-<span class="number">3.2</span>.<span class="number">11</span>/deps/hiredis<span class="string">'</span></span><br><span class="line"><span class="string">gcc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  net.c</span></span><br><span class="line"><span class="string">make[3]: gcc: Command not found</span></span><br><span class="line"><span class="string">make[3]: *** [net.o] Error 127</span></span><br><span class="line"><span class="string">make[3]: Leaving directory `/stephen/data/program/redis-3.2.11/deps/hiredis'</span></span><br><span class="line">make[<span class="number">2</span>]: *** [hiredis] Error <span class="number">2</span></span><br><span class="line">make[<span class="number">2</span>]: Leaving directory <span class="string">`/stephen/data/program/redis-3.2.11/deps'</span></span><br><span class="line"><span class="string">make[1]: [persist-settings] Error 2 (ignored)</span></span><br><span class="line"><span class="string">    CC adlist.o</span></span><br><span class="line"><span class="string">/bin/sh: cc: command not found</span></span><br><span class="line"><span class="string">make[1]: *** [adlist.o] Error 127</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `</span>/stephen/data/program/redis-<span class="number">3.2</span>.<span class="number">11</span>/src<span class="string">'</span></span><br><span class="line"><span class="string">make: *** [all] Error 2</span></span><br></pre></td></tr></table></figure>

<p>根据提示安装gcc，命令</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install gcc automake autoconf libtool make</span><br></pre></td></tr></table></figure>

<p>提示错误</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd src &amp;&amp; make all</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">`/stephen/data/program/redis-3.2.11/src'</span></span><br><span class="line"><span class="string">    CC adlist.o</span></span><br><span class="line"><span class="string">In file included from adlist.c:34:0:</span></span><br><span class="line"><span class="string">zmalloc.h:50:31: fatal error: jemalloc/jemalloc.h: No such file or directory</span></span><br><span class="line"><span class="string"> #include &lt;jemalloc/jemalloc.h&gt;</span></span><br><span class="line"><span class="string">                               </span></span><br><span class="line"><span class="string">compilation terminated.</span></span><br><span class="line"><span class="string">make[1]: *** [adlist.o] Error 1</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `</span>/stephen/data/program/redis-<span class="number">3.2</span>.<span class="number">11</span>/src<span class="string">'</span></span><br><span class="line"><span class="string">make: *** [all] Error 2</span></span><br></pre></td></tr></table></figure>

<p>根据提示执行</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make MALLOC=libc</span><br></pre></td></tr></table></figure>

<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> redis</span><br><span class="line">cd redis-<span class="number">3.2</span>.<span class="number">11</span></span><br><span class="line">make install PREFIX=<span class="regexp">/stephen/data</span><span class="regexp">/program/redis</span></span><br></pre></td></tr></table></figure>

<h3 id="5-编译测试"><a href="#5-编译测试" class="headerlink" title="5.编译测试"></a>5.编译测试</h3><p>通过make test测试编译状态</p>
<p>报错</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd src &amp;&amp; make test</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">`/stephen/data/program/redis-3.2.11/src'</span></span><br><span class="line"><span class="string">You need tcl 8.5 or newer in order to run the Redis test</span></span><br><span class="line"><span class="string">make[1]: *** [test] Error 1</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `</span>/stephen/data/program/redis-<span class="number">3.2</span>.<span class="number">11</span>/src<span class="string">'</span></span><br><span class="line"><span class="string">make: *** [test] Error 2</span></span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://nchc.dl.sourceforge.net/project/tcl/Tcl/8.6.8/tcl8.6.8-src.tar.gz</span><br><span class="line">sudo tar zxvf tcl8.6.1-src.tar.gz  -C /usr/local/  </span><br><span class="line">cd  /stephen/data/program/tcl8.6.1/unix/  </span><br><span class="line">./configure  </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="6-make-install-prefix-path-完成安装"><a href="#6-make-install-prefix-path-完成安装" class="headerlink" title="6.make install [prefix=/path]完成安装"></a>6.make install [prefix=/path]完成安装</h3><h3 id="7-拷贝redis-3-2-11下的conf目录至redis目录下"><a href="#7-拷贝redis-3-2-11下的conf目录至redis目录下" class="headerlink" title="7.拷贝redis-3.2.11下的conf目录至redis目录下"></a>7.拷贝redis-3.2.11下的conf目录至redis目录下</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ../redis-3.2.11</span><br><span class="line">cp redis.conf ../redis/redis.conf</span><br></pre></td></tr></table></figure>



<h2 id="四、redis常用命令"><a href="#四、redis常用命令" class="headerlink" title="四、redis常用命令"></a>四、redis常用命令</h2><p>redis命令-启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd redis</span><br><span class="line">cd bin</span><br><span class="line">./redis -server ../redis.conf</span><br></pre></td></tr></table></figure>

<p>redis启动服务后部分含义</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Running in standalone mode 表示单机模式</span><br><span class="line">6379 默认端口</span><br><span class="line">1590 pid</span><br></pre></td></tr></table></figure>

<p>后台启动运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim redis</span><br><span class="line">/daemonize</span><br><span class="line">修改redis.conf  daemonize=yes</span><br><span class="line">./redis-server ../redis.conf 再次启动</span><br><span class="line">ps -ef | grep redis 查看启动进程</span><br></pre></td></tr></table></figure>

<p>停止服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli shutdown </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#如果更改为外网访问后</span></span></span><br><span class="line">./redis-cli -h 172.16.38.224 -p 6379 shutdown</span><br></pre></td></tr></table></figure>

<p>连接到启动后redis的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli</span><br></pre></td></tr></table></figure>

<p>远程访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 127.0.0.1 -p 6379（正确命令）</span><br><span class="line">  输入一下命令时./redis-cli -h 172.16.38.224 -p 6379</span><br><span class="line">  提示错误：Could not connect to Redis at 172.16.38.224:6379: Connection refused</span><br><span class="line">  Could not connect to Redis at 172.16.38.224:6379: Connection refused</span><br></pre></td></tr></table></figure>

<p>redis-server 启动服务</p>
<p>redis-cli 访问到redis的控制台</p>
<p>redis-benchmark 性能测试的工具</p>
<p>redis-check-aof aof文件进行检测的工具</p>
<p>redis-check-dump  rdb文件检查工具</p>
<p>redis-sentinel  sentinel 服务器配置（哨兵）</p>
<h2 id="五、多数据支持"><a href="#五、多数据支持" class="headerlink" title="五、多数据支持"></a>五、多数据支持</h2><p>默认支持16个数据库（dbid ：0-15），可以理解为一个命名空间，不同的命名空间可以拥有相同的key</p>
<p>进入不同数据库命名空间命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select dbib（如selct 5)</span><br></pre></td></tr></table></figure>

<p>跟关系型数据库不一样的点</p>
<p>1.redis不支持自定义数据库名称</p>
<p>2.每个数据库不能单独设置授权（不能设置单独的用户名，密码）</p>
<p>3.每个数据库之间并不是完全隔离的。可以通过flushall命令清空redis实例面的所有数据库中的数据</p>
<p>通过  select dbid 去选择不同的数据库命名空间 。 dbid的取值范围默认是0 -15</p>
<h3 id="六、redis使用入门"><a href="#六、redis使用入门" class="headerlink" title="六、redis使用入门"></a>六、redis使用入门</h3><h3 id="1、获取一个符合匹配规则的键名列表"><a href="#1、获取一个符合匹配规则的键名列表" class="headerlink" title="1、获取一个符合匹配规则的键名列表"></a>1、获取一个符合匹配规则的键名列表</h3><p>keys pattern [?/*[]]</p>
<p>尽量匹配完整的key</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">keys</span> mic:hobby</span><br></pre></td></tr></table></figure>

<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="keyword">select</span> <span class="number">5</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>[<span class="number">5</span>]&gt; <span class="keyword">select</span> <span class="number">0</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="keyword">keys</span> mic:hobby</span><br><span class="line">(empty list <span class="keyword">or</span> set)</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="keyword">keys</span> mic*</span><br><span class="line">(empty list <span class="keyword">or</span> set)</span><br></pre></td></tr></table></figure>



<h3 id="2、判断一个键是否存在-EXISTS-key"><a href="#2、判断一个键是否存在-EXISTS-key" class="headerlink" title="2、判断一个键是否存在 EXISTS key"></a>2、判断一个键是否存在 EXISTS key</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EXISTS mic</span><br><span class="line">(integer) <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h3 id="3、type-key去获得这个key的数据结构类型"><a href="#3、type-key去获得这个key的数据结构类型" class="headerlink" title="3、type key去获得这个key的数据结构类型"></a>3、type key去获得这个key的数据结构类型</h3><p>【type key】type命令实际返回的就是当前键的数据结构类型，它们分别是：string（字符串）、hash（哈希）、list（列表）、set（集合）、zset（有序集合）</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; type hello</span><br><span class="line">string</span><br></pre></td></tr></table></figure>

<p>【object encoding key】可以看到每种数据结构都有两种以上的内部编码实现，例如list数据结构包含了linkedlist和ziplist两种内部编码。同时有些内部编码，例如ziplist，可以作为多种外部数据结构的内部实现，可以通过object encoding命令查询内部编码</p>
<h2 id="七、各种数据结构的使用"><a href="#七、各种数据结构的使用" class="headerlink" title="七、各种数据结构的使用"></a>七、各种数据结构的使用</h2><h3 id="1、字符类型"><a href="#1、字符类型" class="headerlink" title="1、字符类型"></a>1、字符类型</h3><p>应用场景：分布式锁【setnx key value】、短信重发机制</p>
<p>短信重发机制：sms：limit：mobile （138…….. expire）</p>
<p>存放内容：二进制数据（图片、音频、视频），json字符串、json序列化后的流、xml、数字（整数、浮点数）</p>
<p>存放大小：一个字符类型的key默认存储的最大容量是512MB</p>
<p>key的设计：对象类型:对象id:对象属性:对象子属性，不建议太长，导致占用内存</p>
<p>注意事项：a) 建议对key进行分类，同步在wiki统一管理</p>
<p>b)    redis可以支撑每秒数万的读写操作，但是这指的是redis服务端的处理能力，但对于客户端来说，一次命令除了命令时间还有网络时间，假设网络时间为1ms，命令时间为0.1（按每秒处理1万IAO命令算，那么执行1000次get命令与1次mget命令的区别）如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>操作</th>
<th>时间</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1000次get</td>
<td>1000 * 1 + 1000 * 0.1 = 1100ms = 1.1s</td>
</tr>
<tr>
<td>2</td>
<td>1次mget（组装1000个键值对）</td>
<td>1 * 1 + 1000 * 0.1 = 101ms = 0.101s</td>
</tr>
</tbody></table>
<p>对于开发人员来说，redis的处理能力已经足够高，网络可能会成为性能的瓶颈</p>
<p>c) redis使用批量操作，有助于提高效率，但是每次批量操作所发送的命令不是无节制的，数量过多会可能会造成redis阻塞或者网络阻塞。</p>
<p>【SET  key value】赋值</p>
<p>【GET key】取值</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; set hello world</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line"><span class="string">"world"</span></span><br></pre></td></tr></table></figure>

<p>递增数字 （场景：验证码输入次数）</p>
<p>【incr key】去对当前键的值做原子递增+1，key需为数值，不然会报以下错误</p>
<p>a) 当前key的value的不是整数，返回错误；</p>
<p>b) 当前key的value是整数，返回自增后的结果；</p>
<p>c) key不存在，按照值为0自增，返回结果为1</p>
<p>eg：例如对一个不存在的键执行incr操作后，返回结果是1，再次对键执行incr命令，返回结果是2：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incr hello</span><br><span class="line">(error) ERR value is <span class="keyword">not</span> an integer <span class="keyword">or</span> out of range</span><br></pre></td></tr></table></figure>

<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; set mic:age <span class="number">18</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incr mic:age</span><br><span class="line">(integer) <span class="number">19</span></span><br><span class="line">此代码中key为<span class="string">"mic:age"</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; set age <span class="number">20</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incr age</span><br><span class="line">(integer) <span class="number">21</span></span><br></pre></td></tr></table></figure>

<p>错误演示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> value = get key;</span><br><span class="line">value = value + <span class="number">1</span>;</span><br><span class="line">set key value;</span><br></pre></td></tr></table></figure>

<p>【decr key】原子减一</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; decr age</span><br><span class="line">(integer) <span class="number">25</span></span><br></pre></td></tr></table></figure>

<p>【incrby key n】递增指定的整数</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">incrby key n（eg：incrby age <span class="number">5</span>）表示key（age）递增加<span class="number">5</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incrby age <span class="number">5</span></span><br><span class="line">(integer) <span class="number">26</span></span><br></pre></td></tr></table></figure>

<p>【decrby key n】自减指定数字</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; decr age</span><br><span class="line">(integer) <span class="number">25</span></span><br></pre></td></tr></table></figure>

<p>【incrbyfloat】自增浮点数</p>
<p>【append key value】向指定的key对value的值进行追加</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; append hello -mic</span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line"><span class="string">"world-mic"</span></span><br></pre></td></tr></table></figure>

<p>【strlen key】获取key对应的value长度c</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; strlen hello</span><br><span class="line">(integer) <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p>【mget key key…】同时获得多个key的value</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; mget mic:age age hello</span><br><span class="line"><span class="number">1</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"25"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"world-mic"</span></span><br></pre></td></tr></table></figure>

<p>【mset key value kye value key value…】同时存储多个key value</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; mset xiaoma man mic man feifei women</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; mget xiaoma mic feifei</span><br><span class="line"><span class="number">1</span>) <span class="string">"man"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"man"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"women"</span></span><br></pre></td></tr></table></figure>

<p>【setnx】实现分布式锁，由于redis的单线程命令处理机制，如果有多个客户端同事执行【setnx key value】，根据【setnx】的特性只有一个客户端能设置成功，【setnx】可以作为分布式锁的一种实现方案，Redis官方给出了使用setnx实现分布式锁的方法：<a href="http://redis.io/topics/distlock" target="_blank" rel="noopener">http://redis.io/topics/distlock</a></p>
<h3 id="2、列表类型"><a href="#2、列表类型" class="headerlink" title="2、列表类型"></a>2、列表类型</h3><p>list 可以存储一个有序的字符串列表，列表中的元素可以重复。一个列表最多可以存储2的32次方-1个元素。</p>
<p>应用场景：可实现分布式队列，实际使用过程用【blpop/brpop】</p>
<p>消息队列：使用redis中的lpush+ brpop命令即可组合即可实现阻塞队列，生产者客户端使用lpush从列表左侧插入元素，多个消费者客户端使用brpop命令阻塞式的”抢”列表尾部的元素，多个客户端保证了消费的负载均衡和高可用性。</p>
<p>文章列表：每个用户都有自己的文章列表，需要分页显示文档列表，不仅是有序的，同时支持索引范围获取元素</p>
<p>lpush + lpop = Stack（栈）<br>lpush + rpop = Queue（队列）<br>lpsh + ltrim  = Capped Collection（有限集合）<br>lpush + brpop = Message Queue（消息队列）</p>
<p>【lpush/rpush】从左边或右边push数据。”l”表示往左边push，”r”表示从右边push数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">18</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">19</span></span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">20</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">17</span></span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush num <span class="number">16</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"16"</span></span><br></pre></td></tr></table></figure>

<p>【lpop/rpop】从左边或右边移除(pop)数据，并得到移除的值。”l”表示往左边开始，”r”表示从右边开始。如果list为空，则返回nil</p>
<p>实现分布式队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpop num</span><br><span class="line"><span class="string">"17"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpop num</span><br><span class="line"><span class="string">"16"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpop num</span><br><span class="line"><span class="string">"18"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpop num</span><br><span class="line"><span class="string">"19"</span></span><br></pre></td></tr></table></figure>

<p>【llen key】获取列表长度</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; llen num</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>【lrange key start stop】：索引可以是负数，-1表示最右边的第一个元素。也可以比列表长度大</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">19</span></span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">18</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">17</span></span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">16</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush num <span class="number">15</span></span><br><span class="line">(integer) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush num <span class="number">21</span></span><br><span class="line">(integer) <span class="number">7</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">3</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"16"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">10</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"16"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">7</span>) <span class="string">"21"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"16"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">7</span>) <span class="string">"21"</span></span><br></pre></td></tr></table></figure>

<p>【lrem num count value】删除指定的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrem num <span class="number">1</span> <span class="number">16</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"21"</span></span><br></pre></td></tr></table></figure>

<p>【lset key index value】修改某个指定下标下的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"18"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"21"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lset num <span class="number">2</span> <span class="number">99</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrange num <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"15"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"17"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"99"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"19"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"20"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"21"</span></span><br></pre></td></tr></table></figure>

<h3 id="3、散列类型"><a href="#3、散列类型" class="headerlink" title="3、散列类型"></a>3、散列类型</h3><p>hash key value 不支持数据类型的嵌套，比较适合存储对象。存放比较复杂的对象</p>
<p>hash与关系型数据库的不同之处</p>
<p>a）hash是稀疏的，而关系型数据库是完全结构化的，hash每个键都可以有不同field，而关系型数据库一旦添加新的行，所有的行都要为其设置值（即使为null）</p>
<p>b）关系型数据库可以做复杂的关系查询，而redis去模拟关系型复杂查询开发困难，维护成本高。</p>
<p>如对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> age = <span class="number">18</span>;</span><br><span class="line">  String sex = <span class="string">"男"</span>;</span><br><span class="line">  String name = <span class="string">"mic"</span>;</span><br><span class="line">&#125;</span><br><span class="line">类似</span><br><span class="line">person</span><br><span class="line">age  <span class="number">18</span></span><br><span class="line">sex   男</span><br><span class="line">name mic</span><br></pre></td></tr></table></figure>

<p>【hset key field value】</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hset key person.age <span class="number">20</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hset key person.name mic</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hset key person.sex male</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>【hget key filed】(09:08图)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hget key</span><br><span class="line">(error) ERR wrong number of arguments for 'hget' command</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hget key person</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hget key person.age</span><br><span class="line"><span class="string">"20"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hget key person.name</span><br><span class="line"><span class="string">"mic"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hget key person.sex</span><br><span class="line"><span class="string">"male"</span></span><br></pre></td></tr></table></figure>

<p>【hmset key filed value [filed value]…】一次性设置多个值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hmset user age <span class="number">25</span> sex female name feifei</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>【hmget key filed filed…】一次性获取多个值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hmget user age sex name</span><br><span class="line"><span class="number">1</span>) <span class="string">"25"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"female"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"feifei"</span></span><br></pre></td></tr></table></figure>

<p>【hgetall key】获取hash的所有信息，包括key和value</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hgetall user</span><br><span class="line"><span class="number">1</span>) <span class="string">"age"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"25"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"sex"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"female"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"name"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"feifei"</span></span><br></pre></td></tr></table></figure>

<p>【hexists key field】判断字段是否存在。 存在返回1. 不存在返回0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hexists user age</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hexists user school</span><br><span class="line">(integer) <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>【hincryby】原子递增</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>【hdel key field [field …]】 删除一个或者多个字段</p>
<h3 id="4、集合类型"><a href="#4、集合类型" class="headerlink" title="4、集合类型"></a>4、集合类型</h3><p>set跟list不一样的点，集合烈性不能存在重复的数据，而且是无序的，不能通过索引下标获取元素，支持多个集合取并集、差集、交集</p>
<p>应用场景：标签。电商网站的商品推送、抽奖、标签、社交</p>
<p>生成随机数，抽奖</p>
<p>比如针对数码产品比较感兴趣的人，通过页面或邮件推送最新的数码产品</p>
<p>用户交友，对娱乐、体育感兴趣的人，与历史、新闻感兴趣的人之间的共同兴趣点</p>
<p>【sadd key member [merber…]】增加对应的数据，如果value已经存在，则会忽略存在的值，并且返回成功加入的元素的数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd order <span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd order <span class="number">1</span> <span class="number">2</span> </span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd order <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>【smembers key】增加对应的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; smembers order</span><br><span class="line"><span class="number">1</span>) <span class="string">"1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"2"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"3"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"4"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"5"</span></span><br></pre></td></tr></table></figure>

<p>【sdiff key key …】对多个集合执行差集运算（微博互相关注），返回的是第一个key的差异结果集 ，key1 - key2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; smembers order</span><br><span class="line"><span class="number">1</span>) <span class="string">"1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"2"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"3"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"4"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"5"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd order2 <span class="number">2</span> <span class="number">3</span> <span class="number">6</span> <span class="number">8</span></span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sdiff order order2</span><br><span class="line"><span class="number">1</span>) <span class="string">"1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"4"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"5"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sdiff order2 order</span><br><span class="line"><span class="number">1</span>) <span class="string">"6"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"8"</span></span><br></pre></td></tr></table></figure>

<p>比较两个同一个集合时</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sdiff order2 order2</span><br><span class="line">(empty <span class="built_in">list</span> <span class="keyword">or</span> <span class="built_in">set</span>)</span><br></pre></td></tr></table></figure>

<p>【sunion key key…】对多个集合执行并集操作, 同时存在在两个集合里的所有值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sunion order order2</span><br><span class="line"><span class="number">1</span>) <span class="string">"1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"2"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"3"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"4"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"5"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"6"</span></span><br><span class="line"><span class="number">7</span>) <span class="string">"8"</span></span><br></pre></td></tr></table></figure>



<h3 id="5、有序集合"><a href="#5、有序集合" class="headerlink" title="5、有序集合"></a>5、有序集合</h3><p>有序集合：保留了集合不能有重复元素的特性，但不同的是，有序集合中的元素可以排序，有序集合通过给每个元素设置一个分数（score）作为排序的依据，与列表使用索引下标排序不同。</p>
<p>有序集合中的元素不可重复，但是score可重复。如同班级的学号不能重复，但是考试成绩可以相同</p>
<p>应用场景：网站访问的前10名、热搜、视频的时间排行榜、视频的播放量排行榜、视频的点赞数排行等。</p>
<p>【zadd key score member】score决定集合元素的优先级</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd teacher <span class="number">10</span> mic <span class="number">8</span> james <span class="number">12</span> tom</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zrange teacher <span class="number">0</span> <span class="number">3</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"james"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"mic"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"tom"</span></span><br></pre></td></tr></table></figure>

<p>【zrange key start stop [withscores] 】去获得元素。 withscores是可以获得元素的分数。</p>
<p>如果两个元素的score是相同的话，那么根据(0&lt;9&lt;A&lt;Z&lt;a&lt;z) 方式从小到大</p>
<p>应用场景：网站访问的前10名。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zrange teacher <span class="number">0</span> <span class="number">3</span> withscores</span><br><span class="line"><span class="number">1</span>) <span class="string">"james"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"8"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"mic"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"10"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"tom"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"12"</span></span><br></pre></td></tr></table></figure>



<h3 id="6、三种缓存方法优缺点分析"><a href="#6、三种缓存方法优缺点分析" class="headerlink" title="6、三种缓存方法优缺点分析"></a>6、三种缓存方法优缺点分析</h3><p>a） 原生字符串类型，每个属性一个键</p>
<p>优点：简单直观，每个键都支持更新操作</p>
<p>缺点：占用过多的key，内存占用量比较大，同时用户信息内聚性较差，一般不会再生产环境使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> user:<span class="number">1</span>:name tom</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> user:<span class="number">1</span>:age <span class="number">23</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> user:<span class="number">1</span>:city beijing</span><br></pre></td></tr></table></figure>

<p>b）序列化字符串类型：将用户信息序列化后用一个键保存</p>
<p>优点：简化编程，合理的使用序列化可以提高内存的使用效率；</p>
<p>缺点：序列化和反序列化有一定的开销，同时每次更新属性都需要把全部的数据取出反序列化，更新后再序列化到redis中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> user:<span class="number">1</span> serialize(userinfo)</span><br></pre></td></tr></table></figure>

<p>c）哈希类型：每个用户属性使用一堆filed-value，但是只用一个键保存</p>
<p>优点：简单直观，如果合理使用可以减少内存空间的使用</p>
<p>缺点：要控制hash在ziplist和hashtable两种内部编码的转换，hashtable会消耗更多内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; hmset user:<span class="number">1</span> name tom age <span class="number">18</span> city beijing</span><br></pre></td></tr></table></figure>



<h2 id="八、redis的事务处理"><a href="#八、redis的事务处理" class="headerlink" title="八、redis的事务处理"></a>八、redis的事务处理</h2><p>把几种命令放到一个事务里面执行，要么命令都执行，要么都不执行</p>
<p>【multi】开启事务</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>事务执行过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> userinfo:name mic</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> userinfo:age <span class="number">18</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">2</span>) OK</span><br></pre></td></tr></table></figure>

<p>执行多种数据类型操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> xxx yyy</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd ky <span class="number">222</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> iii <span class="number">111</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">2</span>) (integer) <span class="number">1</span></span><br><span class="line"><span class="number">3</span>) OK</span><br></pre></td></tr></table></figure>

<p>事务回滚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> aaa bbb</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> xxx</span><br><span class="line">(error) ERR wrong number of arguments for 'set' command</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> aaa</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> aaa</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p>事务部分回滚，与数据库的回滚机制不是完全一致</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd memebers <span class="string">"bugai"</span> <span class="string">"tengteng"</span> <span class="string">"feiyang"</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush usernames <span class="string">"b"</span> <span class="string">"|"</span> <span class="string">"y"</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd pawwword <span class="string">"123456 "</span><span class="number">123456</span><span class="string">" "</span><span class="number">123456</span><span class="string">"</span></span><br><span class="line"><span class="string">Invalid argument(s)</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; exec</span></span><br><span class="line"><span class="string">1) (integer) 3</span></span><br><span class="line"><span class="string">2) (integer) 3</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; get pawword</span></span><br><span class="line"><span class="string">(nil)</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; get memebers</span></span><br><span class="line"><span class="string">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; </span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; </span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; get usernames</span></span><br><span class="line"><span class="string">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt;</span></span><br><span class="line"><span class="string">##pawwword 少写一个符号</span></span><br></pre></td></tr></table></figure>

<p>事务部分回滚测试2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd memebers <span class="string">"bugai"</span> <span class="string">"litengfeng"</span> <span class="string">"yangyiyang"</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush username <span class="string">"b"</span> <span class="string">"l"</span> <span class="string">"y"</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; sadd password <span class="string">"123456"</span> <span class="string">"123456"</span> <span class="string">"123456"</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) (integer) <span class="number">2</span></span><br><span class="line"><span class="number">2</span>) (integer) <span class="number">3</span></span><br><span class="line"><span class="number">3</span>) (integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> memebers</span><br><span class="line">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> username</span><br><span class="line">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> password</span><br><span class="line">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure>



<h2 id="九、过期时间"><a href="#九、过期时间" class="headerlink" title="九、过期时间"></a>九、过期时间</h2><p>【expire key seconds】设置过期时间，当超过过期时间后，会自动删除键。默认是永久，永不过期，避免数据永远在内存里面或失效后仍在内存</p>
<p>【ttl】 获得key的过期时间</p>
<p>ttl命令会返回键的剩余过期时间，它有3种返回值</p>
<p>大于等于0的整数：键剩余的过期时间。<br>-1：键没设置过期时间。<br>-2：键不存在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> demo1 value</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; expire demo1 <span class="number">10</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"> # 还剩 <span class="number">6</span> 秒</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"> # 还剩 <span class="number">1</span> 秒</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line">## 返回结果为 <span class="number">-2</span> ，说明键 hello 已经被删除</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">-2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">-2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">-2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl demo1</span><br><span class="line">(integer) <span class="number">-2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> demo1</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>



<h2 id="十、发布订阅"><a href="#十、发布订阅" class="headerlink" title="十、发布订阅"></a>十、发布订阅</h2><p>可支持订阅多个（不稳定，性能太差），redis默认不提供对外访问，通过bind设置</p>
<p>【publish channel message】发布消息（消息发送端）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; publish queuel hello</span><br><span class="line">(integer) <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>设置redis可通过外网访问，将”bind 127.0.0.1”注释掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"><span class="meta">#bind 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br></pre></td></tr></table></figure>

<p>将protected-mode改为no，即将保护模式关闭</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># By <span class="keyword">default</span> <span class="keyword">protected</span> mode is enabled. You should disable it only <span class="keyword">if</span></span><br><span class="line"><span class="meta"># you are sure you want clients from other hosts to connect to Redis</span></span><br><span class="line"><span class="meta"># even <span class="meta-keyword">if</span> no authentication is configured, nor a specific set of interfaces</span></span><br><span class="line"><span class="meta"># are explicitly listed using the <span class="meta-string">"bind"</span> directive.</span></span><br><span class="line"><span class="keyword">protected</span>-mode no</span><br></pre></td></tr></table></figure>

<p>重启打开一个页面，登录客户端（消息接收端）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 ~]<span class="meta"># cd /distributed/data/program/redis/bin</span></span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli </span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; subscribe queue1</span><br><span class="line">Reading messages... (<span class="built_in">press</span> Ctrl-C to quit)</span><br><span class="line"><span class="number">1</span>) <span class="string">"subscribe"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"queue1"</span></span><br><span class="line"><span class="number">3</span>) (integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>发送端再次发送消息”test”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; publish queuel hello</span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; </span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># vim ../redis.conf </span></span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># vim ../redis.conf </span></span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli <span class="built_in">shutdown</span></span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-server ../redis.conf </span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># vim ../redis.conf </span></span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># publish queue1 test</span></span><br><span class="line">-bash: publish: command <span class="keyword">not</span> found</span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli </span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; publish queue1 test</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>接收端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; subscribe queue1</span><br><span class="line">Reading messages... (<span class="built_in">press</span> Ctrl-C to quit)</span><br><span class="line"><span class="number">1</span>) <span class="string">"subscribe"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"queue1"</span></span><br><span class="line"><span class="number">3</span>) (integer) <span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"message"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"queue1"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"test"</span></span><br></pre></td></tr></table></figure>



<h2 id="十一、分布式锁的解决方案"><a href="#十一、分布式锁的解决方案" class="headerlink" title="十一、分布式锁的解决方案"></a>十一、分布式锁的解决方案</h2><p>理解比较简单：数据库分布式锁，实现比较简单：zookeeper分布式锁</p>
<h3 id="1、数据库可以做（-activemq）"><a href="#1、数据库可以做（-activemq）" class="headerlink" title="1、数据库可以做（ activemq）"></a>1、数据库可以做（ activemq）</h3><p>用broker往同一个数据库的同一个表中写数据，谁先写入谁就是master，即抢到了分布式锁，负责执行。其他就是salve。</p>
<p>怎么获取锁：数据库，通过唯一约束</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span>(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>),</span><br><span class="line">  methodName <span class="built_in">varchar</span>(<span class="number">100</span>), <span class="comment">-- 方法名称</span></span><br><span class="line">  memo <span class="built_in">varchar</span>(<span class="number">1000</span>),</span><br><span class="line">  modifyTime <span class="built_in">timestamp</span>,</span><br><span class="line">  <span class="keyword">unique</span> <span class="keyword">key</span> mn (method)  <span class="comment">--唯一约束</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>实现原理：同一个方法往同一个数据库中的同一张表写入数据，因为唯一约束字段的存在，插入成功的即是表名获得了锁，在执行完成后再删除此数据，由其它进程再次抢锁。</p>
<p>非重入锁，若要更改为重入锁保存ownerid，下次进入时获取</p>
<p>获取锁的伪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">获取锁的伪代码</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="function">exec  insert into <span class="title">lock</span><span class="params">(methodName,memo)</span> <span class="title">values</span><span class="params">(<span class="string">'method'</span>,<span class="string">'desc'</span>)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;Catch(DuplicateException e)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">或通过<span class="keyword">for</span> update执行行锁</span><br><span class="line">select -<span class="number">1</span> <span class="keyword">for</span> update （悲观锁）</span><br><span class="line">乐观锁</span><br></pre></td></tr></table></figure>

<p>释放锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">lock</span> <span class="keyword">where</span> methodName=<span class="string">''</span>;</span><br></pre></td></tr></table></figure>

<p>存在的需要思考的问题：</p>
<p>a) 锁没有失效时间，一旦解锁操作失败，就会导致锁记录一直在数据库中，其他线程无法再获得到锁</p>
<p>b) 锁是非阻塞的，数据的insert操作，一旦插入失败就会直接报错，没有获得锁的线程并不会进入排队队列，要想再次获得锁就要再次触发锁操作</p>
<p>c) 锁是非重入的，同一个线程在没有释放锁之前无法再次获得该锁</p>
<h3 id="2、缓存-redis-setnx"><a href="#2、缓存-redis-setnx" class="headerlink" title="2、缓存 -redis setnx"></a>2、缓存 -redis setnx</h3><p>【setnx】在key不存在的情况下可以为key设置一个值，若存在则无法设置</p>
<h3 id="3、zookeeper"><a href="#3、zookeeper" class="headerlink" title="3、zookeeper"></a>3、zookeeper</h3><p>创建临时有序节点/创建唯一节点名称，谁创建成功，谁就获得了这个锁。</p>
<p><img src="/../../images/redis/zookeeper%E7%AB%9E%E4%BA%89%E9%94%81.png" alt="zookeeper"></p>
<p>zookeeper分布式锁</p>
<p>a) watcher事件，获取节点删除后的主动通知，</p>
<p>b) 基于临时节点，会话失效后节点会被删除</p>
<p>zookeeper分布式锁的优势：</p>
<p>a）可靠性，实现简单</p>
<p>b）zookeeper因为临时节点的原因，如果其他客户端因为异常和zookeeper连接中断了，那么节点会被删除，意味着锁会被自动释放</p>
<p>c）zookeeper本身提供了一套很好的集群方案，比较稳定</p>
<p>d）释放锁操作，会有watcher通知机制，也就是服务端会主动发送消息给客户端这个锁已经被释放了</p>
<h3 id="4、mysql中排它锁的用法（悲观锁-乐观锁）"><a href="#4、mysql中排它锁的用法（悲观锁-乐观锁）" class="headerlink" title="4、mysql中排它锁的用法（悲观锁/乐观锁）"></a>4、mysql中排它锁的用法（悲观锁/乐观锁）</h3><p>排它锁的申请前提：</p>
<p>a) 没有线程对该结果集中的任何行数据使用排它锁或共享锁，否则申请会被阻塞</p>
<p>b) for update仅适用于innoDB，且必须在事务块（BEGIN/COMMIT）中才能生效，进行事务操作时，通过”for update”语句，mysql会对查询结果集中每行数据都添加排它锁，其他线程对该纪录的更新与删除操作都会被阻塞。排它锁包含行锁、表锁。</p>
<p>排它锁注意事项：</p>
<p>a) innoDB行锁是通过索引上的索引项加锁来实现的，只有通过索引条件检索数据，innoDB才使用行级索，否则，innoDB将使用表锁</p>
<p>b) 由于mysql的行锁是针对索引加的锁，不是针对记录加的锁，所以虽然是访问不同行的记录，但是如果使用相同的索引键，是会出现锁冲突的，应用设计时应注意到这一点</p>
<p>c) 当表有多个索引时，不同的事务可以使用不同的索引锁定不同的行，另外，不论使用主键索引、唯一索引或普通索引，InnoDB都会使用行锁对数据枷锁</p>
<p>d) 即便在条件中使用了索引字段，但是否使用索引来检索数据是由mysql通过判断不同执行计划的代价来决定的，如果mysql认为全表扫描效率更高（比如一些很小的表），它就不会使用索引，这种情况下innoDB将使用表锁，而不是行锁。因此，在分析锁冲突时，需检查SQL的执行计划，以确认真正使用到了索引。</p>
<p>e) 检索值的数据类型与索引字段不同，虽然mysql能够进行数据类型转换，当却不会使用，从而导致innoDB使用表锁。</p>
<p>f) 可以通过用explain检查SQL的执行计划</p>
<p>用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select .. for update;</span><br><span class="line">eg: select * from goods where id &#x3D; 1 for update;</span><br></pre></td></tr></table></figure>

<p>应用场景：</p>
<p>假设有一张商品表goods，包含：id、商品名称、库存量三个字段，表结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;goods&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;name&#96; varchar(100) DEFAULT NULL,</span><br><span class="line">  &#96;stock&#96; int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;idx_name&#96; (&#96;name&#96;) USING HASH</span><br><span class="line">) ENGINE&#x3D;InnoDB;</span><br></pre></td></tr></table></figure>

<p>插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;1&#39;, &#39;prod11&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;2&#39;, &#39;prod12&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;3&#39;, &#39;prod13&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;4&#39;, &#39;prod14&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;5&#39;, &#39;prod15&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;6&#39;, &#39;prod16&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;7&#39;, &#39;prod17&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;8&#39;, &#39;prod18&#39;, &#39;1000&#39;);</span><br><span class="line">INSERT INTO &#96;goods&#96; VALUES (&#39;9&#39;, &#39;prod19&#39;, &#39;1000&#39;);</span><br></pre></td></tr></table></figure>

<p>数据一致性：</p>
<p>假设A、B两个用户同时各购买一件id =1 的商品，用户A获取的库存量为1000，用户B获取到的库存量也为1000，用户A完成购买后修改该商品的库存量为999，用户B完成购买后修改该商品的库存量为999，此时库存量数据产生了不一致。</p>
<p>两种解决方法：</p>
<p>悲观锁：每次获取商品时，对该商品加排它锁。也就是在用户A获取id=1的商品信息时对该行记录枷锁，期间阻塞其他用户，等待用户A访问该纪录完成。悲观锁适合写入频繁的场景。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where id &#x3D;1 for update;</span><br><span class="line">update goods set stock &#x3D; stock -1 where id &#x3D; 1;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>乐观锁方案：每次获取商品时，不对该商品加锁。在更新数据的时候需要比较程序中的库存量与数据库中的库存量是否相等，如果相等则进行更新，防止程序重新获取库存量，再次进行比较，知道两个库存量的数值相等才进行数据更新。乐观锁适合读取频繁的场景。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#不加锁获取id&#x3D;1的商品对象</span><br><span class="line">select * from goods where id &#x3D;1;</span><br><span class="line">begin;</span><br><span class="line">#更新stock值，这里需要注意where条件&quot;and stock &#x3D; cur_stock&quot;，只有程序中获取的库存量与数据库中的库存量相等才能执行。</span><br><span class="line">update goods set stocks &#x3D; stock - 1 where id &#x3D;1 and stock &#x3D; cur_stock;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>设计商城系统，该如何选择以上方案（悲观锁/乐观锁）？</p>
<p>查询商品的频率比下单支付的频次高，基于以上可能会优先考虑第二种方案。</p>
<p>行锁与表锁</p>
<p>只根据主键进行查询，并且查询到数据，主键字段产生行锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where id &#x3D; 1 for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>只根据主键进行查询，没有查询到数据，不产生所。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where id &#x3D; 10 for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据主键索引、非主键索引（name）进行查询，并且查询到数据，主键字段产生行锁，name字段产生行锁。</p>
<p>如果其他线程按主键字段进行再次查询，则主键字段产生行锁；</p>
<p>如果其他线程按非主键不含索引字段进行进行查询，则非主键不含索引字段产生表锁；</p>
<p>如果其他线程按非主键索引字段进行查询，则非主键索引字段产生行锁；</p>
<p>如果索引值是枚举类型，mysql也会进行表锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where id &#x3D; 1 and name &#x3D;&#39;prod11&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据主键索引、非主键索引（name）进行查询，没有查询到数据，不产生锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where id &#x3D;1 and name &#x3D;&#39;prod12&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据非主键索引（name）进行查询，没有查询到数据，不产生锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where name &#x3D;&#39;prod20&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据非主键索引（name）进行查询，查询到数据，name字段产生生锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where name &#x3D;&#39;prod11&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据非主键不含索引字段（stock）进行查询，并且查询到数据，stock字段产生表锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where stock &#x3D; 1000 for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>根据非主键不含索引字段（stock）进行查询，没有查询到数据，stock字段产生表锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from goods where stock &#x3D; 2000 for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>只根据主键索引进行查询，查询条件为不等于（&lt;&gt;、like）时，没有查询到数据，主键字段产生表锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#不等于&lt;&gt;查询</span><br><span class="line">begin;</span><br><span class="line">select * from goods where id &lt;&gt; 1 for update;</span><br><span class="line">commit;</span><br><span class="line">#like查询</span><br><span class="line">begin;</span><br><span class="line">select * from goods where id like &#39;1&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>只根据主键索引进行查询，查询条件为不等于（&lt;&gt;、like）时，没有查询到数据，主键字段产生表锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#不等于&lt;&gt;查询</span><br><span class="line">begin;</span><br><span class="line">select * from goods where id &lt;&gt; 1 for update;</span><br><span class="line">commit;</span><br><span class="line"># like查询</span><br><span class="line">begin;</span><br><span class="line">select * from goods where id like &#39;110&#39; for update;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>



<h2 id="十二、redis实现分布式锁"><a href="#十二、redis实现分布式锁" class="headerlink" title="十二、redis实现分布式锁"></a>十二、redis实现分布式锁</h2><p>单进程模型：</p>
<p>锁是用来解决什么问题的：synchronize、lock</p>
<p>多进程架构：</p>
<p>1.资源共享竞争问题</p>
<p>2.数据安全性</p>
<p>redis后台代码实现</p>
<p>1、引入jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、获取客户端</p>
<p>编写连接至redis的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tt.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">20</span>);</span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">10</span>);</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(jedisPoolConfig,<span class="string">"172.16.38.224"</span>,<span class="number">6379</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getJedis</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != jedisPool) &#123;</span><br><span class="line">            <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"jedisPool is not init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取锁及释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tt.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 获得锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLock</span><span class="params">(String key, <span class="keyword">int</span> timeout)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = RedisManager.getJedis();</span><br><span class="line">            String value = UUID.randomUUID().toString();</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis() + timeout;</span><br><span class="line">            <span class="keyword">while</span> (System.currentTimeMillis() &lt; end) &#123;<span class="comment">//阻塞</span></span><br><span class="line">                <span class="keyword">if</span> (jedis.setnx(key, value) == <span class="number">1</span>)&#123;</span><br><span class="line">                    jedis.expire(key, timeout);</span><br><span class="line">                    <span class="comment">// 锁设置成功，redis操作成功</span></span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (jedis.ttl(key) == -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">// 检查过期时间</span></span><br><span class="line">                    jedis.expire(key,timeout);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 重试时间</span></span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 释放锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseLock</span><span class="params">(String key ,String value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = RedisManager.getJedis();</span><br><span class="line">            jedis.watch(key);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (value.equals(jedis.get(key)))&#123;</span><br><span class="line">                    <span class="comment">// 判断获得锁的线程和当前redis中存的锁是同一个</span></span><br><span class="line">                    Transaction transaction = jedis.multi();</span><br><span class="line">                    transaction.del(key);</span><br><span class="line">                    List&lt;Object&gt; list = transaction.exec();</span><br><span class="line">                    <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                jedis.unwatch();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RedisLock redisLock = <span class="keyword">new</span> RedisLock();</span><br><span class="line">        String lockid = redisLock.getLock(<span class="string">"lock:aa"</span>,<span class="number">1000</span>);</span><br><span class="line">        System.out.println(lockid);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != lockid)&#123;</span><br><span class="line">            System.out.println(<span class="string">"获得锁成功"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String l = redisLock.getLock(<span class="string">"lock:aa"</span>,<span class="number">1000</span>);</span><br><span class="line">        System.out.println(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">redis.clients.jedis.exceptions.JedisDataException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server. 3) If you started the server manually just for testing, restart it with the '--protected-mode no' option. 4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.</span><br><span class="line">	at redis.clients.jedis.Protocol.processError(Protocol.java:<span class="number">127</span>)</span><br><span class="line">	at redis.clients.jedis.Protocol.process(Protocol.java:<span class="number">161</span>)</span><br><span class="line">	at redis.clients.jedis.Protocol.read(Protocol.java:<span class="number">215</span>)</span><br><span class="line">	at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:<span class="number">340</span>)</span><br><span class="line">	at redis.clients.jedis.Connection.getIntegerReply(Connection.java:<span class="number">265</span>)</span><br><span class="line">	at redis.clients.jedis.Jedis.setnx(Jedis.java:<span class="number">422</span>)</span><br><span class="line">	at com.anjubao.redis.RedisLock.getLock(RedisLock.java:<span class="number">18</span>)</span><br><span class="line">	at com.anjubao.redis.RedisLock.main(RedisLock.java:<span class="number">62</span>)</span><br><span class="line">redis.clients.jedis.exceptions.JedisDataException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server. 3) If you started the server manually just for testing, restart it with the '--protected-mode no' option. 4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.</span><br><span class="line">	at redis.clients.jedis.Protocol.processError(Protocol.java:<span class="number">127</span>)</span><br><span class="line">	at redis.clients.jedis.Protocol.process(Protocol.java:<span class="number">161</span>)</span><br><span class="line">	at redis.clients.jedis.Protocol.read(Protocol.java:<span class="number">215</span>)</span><br><span class="line">	at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:<span class="number">340</span>)</span><br><span class="line">	at redis.clients.jedis.Connection.getIntegerReply(Connection.java:<span class="number">265</span>)</span><br><span class="line">	at redis.clients.jedis.Jedis.setnx(Jedis.java:<span class="number">422</span>)</span><br><span class="line">	at com.anjubao.redis.RedisLock.getLock(RedisLock.java:<span class="number">18</span>)</span><br><span class="line">	at com.anjubao.redis.RedisLock.main(RedisLock.java:<span class="number">68</span>)</span><br></pre></td></tr></table></figure>

<p>4、解决</p>
<p>在注释掉的IP模式下添加”bind 172.16.38.224”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">################################## NETWORK #####################################</span><br><span class="line"></span><br><span class="line"># By <span class="keyword">default</span>, <span class="keyword">if</span> no <span class="string">"bind"</span> configuration directive is specified, Redis listens</span><br><span class="line"><span class="meta"># for connections from all the network interfaces available on the server.</span></span><br><span class="line"># It is possible to <span class="built_in">listen</span> to just one <span class="keyword">or</span> multiple selected interfaces <span class="keyword">using</span></span><br><span class="line"><span class="meta"># the <span class="meta-string">"bind"</span> configuration directive, followed by one or more IP addresses.</span></span><br><span class="line">#</span><br><span class="line"># Examples:</span><br><span class="line">#</span><br><span class="line"><span class="meta"># bind 192.168.1.100 10.0.0.1</span></span><br><span class="line"><span class="meta"># bind 127.0.0.1 ::1</span></span><br><span class="line">#</span><br><span class="line"># ~~~ WARNING ~~~ If the computer <span class="built_in">running</span> Redis is directly exposed to the</span><br><span class="line"><span class="meta"># internet, binding to all the interfaces is dangerous and will expose the</span></span><br><span class="line"><span class="meta"># instance to everybody on the internet. So by default we uncomment the</span></span><br><span class="line"><span class="meta"># following bind directive, that will force Redis to listen only into</span></span><br><span class="line"><span class="meta"># the IPv4 lookback interface address (this means Redis will be able to</span></span><br><span class="line"><span class="meta"># accept connections only from clients running into the same computer it</span></span><br><span class="line"><span class="meta"># is running).</span></span><br><span class="line">#</span><br><span class="line"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"><span class="meta">#bind 127.0.0.1</span></span><br><span class="line"> bind <span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span></span><br><span class="line"></span><br><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"># Redis instances left <span class="built_in">open</span> on the internet are accessed <span class="keyword">and</span> exploited.</span><br></pre></td></tr></table></figure>

<p>注意事项：需把默认的保护模式关闭（protected-mode yes更改为protected-mode no）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"># Redis instances left <span class="built_in">open</span> on the internet are accessed <span class="keyword">and</span> exploited.</span><br><span class="line">#</span><br><span class="line"># When <span class="keyword">protected</span> mode is on <span class="keyword">and</span> <span class="keyword">if</span>:</span><br><span class="line">#</span><br><span class="line"># <span class="number">1</span>) The server is <span class="keyword">not</span> binding explicitly to a <span class="built_in">set</span> of addresses <span class="keyword">using</span> the</span><br><span class="line">#    <span class="string">"bind"</span> directive.</span><br><span class="line"># <span class="number">2</span>) No password is configured.</span><br><span class="line">#</span><br><span class="line"># The server only accepts connections from clients connecting from the</span><br><span class="line"># IPv4 <span class="keyword">and</span> IPv6 loopback addresses <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">and</span> ::<span class="number">1</span>, <span class="keyword">and</span> from Unix domain</span><br><span class="line"><span class="meta"># sockets.</span></span><br><span class="line">#</span><br><span class="line"># By <span class="keyword">default</span> <span class="keyword">protected</span> mode is enabled. You should disable it only <span class="keyword">if</span></span><br><span class="line"><span class="meta"># you are sure you want clients from other hosts to connect to Redis</span></span><br><span class="line"><span class="meta"># even <span class="meta-keyword">if</span> no authentication is configured, nor a specific set of interfaces</span></span><br><span class="line"><span class="meta"># are explicitly listed using the <span class="meta-string">"bind"</span> directive.</span></span><br><span class="line"><span class="keyword">protected</span>-mode no</span><br><span class="line"></span><br><span class="line"># Accept connections on the specified port, <span class="keyword">default</span> is <span class="number">6379</span> (IANA #<span class="number">815344</span>).</span><br><span class="line"># If port <span class="number">0</span> is specified Redis will <span class="keyword">not</span> <span class="built_in">listen</span> on a TCP socket.</span><br><span class="line">port <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>5、成功运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e1e2b60b-<span class="number">05</span>d6-<span class="number">40</span>d7-b769-<span class="number">0</span>c7626dfcffe</span><br><span class="line">获得锁成功</span><br><span class="line"><span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>6、再次运行时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">null</span></span><br><span class="line"><span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>7、修改测试main()添加释放锁代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       RedisLock redisLock = <span class="keyword">new</span> RedisLock();</span><br><span class="line">  		<span class="comment">// 获取上次设置的锁</span></span><br><span class="line">       String lockid = redisLock.getLock(<span class="string">"lock:aa"</span>,<span class="number">1000</span>);</span><br><span class="line">       System.out.println(lockid);</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != lockid)&#123;</span><br><span class="line">           System.out.println(<span class="string">"获得锁成功"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">  		<span class="comment">// 释放锁</span></span><br><span class="line">       <span class="keyword">boolean</span> b = redisLock.releaseLock(<span class="string">"lock:aa"</span>,<span class="string">"e1e2b60b-05d6-40d7-b769-0c7626dfcffe"</span>);</span><br><span class="line">       System.out.println(b);</span><br><span class="line">       <span class="comment">// 再次获取锁</span></span><br><span class="line">       String l = redisLock.getLock(<span class="string">"lock:aa"</span>,<span class="number">1000</span>);</span><br><span class="line">       System.out.println(l);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">null</span></span><br><span class="line"><span class="keyword">true</span></span><br><span class="line"><span class="number">945e24</span>db-<span class="number">43</span>db-<span class="number">4</span>de2-bc1b-<span class="number">2</span>b7b04f100d2</span><br><span class="line"><span class="comment">// 表示第一次未获得锁，释放锁以后，第二次重新获得锁</span></span><br></pre></td></tr></table></figure>



<h2 id="十三、redis的高可用"><a href="#十三、redis的高可用" class="headerlink" title="十三、redis的高可用"></a>十三、redis的高可用</h2><p>redis的高可用、redis的持久化策略，使用codis 、twmproxy在redis和应用层中间做了一层封装</p>
<h2 id="十四、redis架构设计"><a href="#十四、redis架构设计" class="headerlink" title="十四、redis架构设计"></a>十四、redis架构设计</h2><p>redis使用了单线程架构和I/O多路复用模型来实现高性能的内存数据库服务</p>
<p>1、单线程模型：</p>
<p>客户端1，设置一个字符串键值对</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> singedemo hello</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>客户端2，对counter做自增操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incr counter</span><br></pre></td></tr></table></figure>

<p>客户端3，对counter做自增操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incr counter</span><br></pre></td></tr></table></figure>

<p>redis单线程高性能（每秒万级别的处理能力）原因：</p>
<p>1.纯内存访问，redis将所有数据放在内存中，内存的响应时间大于为100ns，这是redis达到每秒万级访问的基础；</p>
<p>2.非阻塞I/O，redis会用epoll作为I/O多路复用技术的实现，再加上redis自身的事件处理模型将epoll的连接、读写、关闭都转为事件，不会再网络I/O上浪费过多时间；</p>
<p>3.单线程避免了线程切换和竞态产生的消耗</p>
<p>单线程带来的好处：</p>
<p>1、单线程可以简化数据结构和算法实现，并发数据结构实现相对困难以及开发测试的麻烦</p>
<p>2、单线程避免了线程切换和竞态产生的消耗，对于服务端开发来说，锁和线程切换对性能的影响比较大。</p>
<p>单线程带来的问题：</p>
<p>1、每个命令的执行时间是有要求的，如果某个命令执行多长，会造成其他命令的阻塞，对于redis这种高性能的服务将是致命的。</p>
<p>单线程阻塞的解决：</p>
<p>1、面向快速执行场景</p>
<h3 id="1、客户端与服务端模型：发送命令、执行命令、返回结果"><a href="#1、客户端与服务端模型：发送命令、执行命令、返回结果" class="headerlink" title="1、客户端与服务端模型：发送命令、执行命令、返回结果"></a>1、客户端与服务端模型：发送命令、执行命令、返回结果</h3><p>单线程模型（执行命令）：redis是单线程处理命令，所以一条命令从客户端到服务端不会立刻被执行，所有没那个了都会进入一个队列中，然后逐个被执行，所以上面3个客户端的命令执行顺序是不确定的，但是可以确定不会有2条命令被同时执行，所以2条incr命令无论怎么执行最终结果都是2，不会产生并发问题。这个就是redis单线程的基本模型。</p>
<p>I/O多路复用（发送命令、返回结果、命令排队）：linux的内核会把所有外部设备都看作一个文件来操作，对一个文件的读写操作会调用内核提供的系统命令，返回一个 file descriptor（文件描述符）。对于一个socket的读写也会有响应的描述符，称为socketfd(socket 描述符)。而IO多路复用是指内核一旦发现进程指定的一个或者多个文件描述符IO条件准备好以后就通知该进程</p>
<p>IO多路复用又称为事件驱动，操作系统提供了一个功能，当某个socket可读或者可写的时候，它会给一个通知。当配合非阻塞socket使用时，只有当系统通知我哪个描述符可读了，我才去执行read操作，可以保证每次read都能读到有效数据。操作系统的功能通过select/pool/epoll/kqueue之类的系统调用函数来使用，这些函数可以同时监视多个描述符的读写就绪情况，这样多个描述符的I/O操作都能在一个线程内并发交替完成，这就叫I/O多路复用，这里的复用指的是同一个线程</p>
<p>多路复用的优势在于用户可以在一个线程内同时处理多个socket的 io请求。达到同一个线程同时处理多个IO请求的目的。而在同步阻塞模型中，必须通过多线程的方式才能达到目的</p>
<h3 id="2、同步阻塞I-O、同步非阻塞I-O、多路复用的区别"><a href="#2、同步阻塞I-O、同步非阻塞I-O、多路复用的区别" class="headerlink" title="2、同步阻塞I/O、同步非阻塞I/O、多路复用的区别"></a>2、同步阻塞I/O、同步非阻塞I/O、多路复用的区别</h3><p>同步阻塞I/O：用户线程调用一个read命令，到内核空间去读数据，如果内核空间数据没准备好，那么等待此线程准备好。</p>
<p>同步非阻塞I/O：发起请求到内核空间去读数据，发现内核空间数据还没准备好，立刻返回请求，用户线程通过轮训不断的读取数据，轮训会消耗资源。</p>
<p>多路复用：用户发起请求去读取数据，发现内核空间数据还没准备好，可以等待多个请求，当请求处理完毕后，返回读取的数据。多路复用指的是线程的多路复用，一个线程执行多个事件。</p>
<h2 id="十五、redis中使用lua脚本"><a href="#十五、redis中使用lua脚本" class="headerlink" title="十五、redis中使用lua脚本"></a>十五、redis中使用lua脚本</h2><h3 id="1、lua脚本"><a href="#1、lua脚本" class="headerlink" title="1、lua脚本"></a>1、lua脚本</h3><p>Lua是一个高效的轻量级脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能</p>
<h3 id="2、使用lua脚本的好处"><a href="#2、使用lua脚本的好处" class="headerlink" title="2、使用lua脚本的好处"></a>2、使用lua脚本的好处</h3><p>减少网络开销、原子操作、复用性</p>
<p>a)、减少网络开销，在lua脚本中可以把多个命令放在同一个脚本中执行</p>
<p>b)、原子操作，redis会将这个脚本做一个整理执行，中间不会被其他命令插入。即编写脚本过程中无需担心出现竞态条件</p>
<p>c)、复用性，客户端发送的脚本会用永远存储在redis中，这意味着其他客户端可以服用这一脚本来完成同样的逻辑</p>
<h3 id="3、lua在Linux中的安装"><a href="#3、lua在Linux中的安装" class="headerlink" title="3、lua在Linux中的安装"></a>3、lua在Linux中的安装</h3><p>到官网下载lua的tar.gz的源码包</p>
<p>tar -zxvf lua-5.3.0.tar.gz</p>
<p>进入解压的目录：</p>
<p>cd lua-5.2.0</p>
<p>make linux  (linux环境下编译)</p>
<p>make install</p>
<p>如果报错，说找不到readline/readline.h, 可以通过yum命令安装</p>
<p>yum -y install readline-devel ncurses-devel</p>
<p>安装完以后再make linux  / make install</p>
<p>最后，直接输入 lua命令即可进入lua的控制台</p>
<p>待补充。。。</p>
<h2 id="十六、redis持久化机制"><a href="#十六、redis持久化机制" class="headerlink" title="十六、redis持久化机制"></a>十六、redis持久化机制</h2><p>redis提供了两种持久化策略</p>
<p>服务器宕机或内存出现问题，热点数据、高峰时间访问比较频繁的数据、作为nosql重要的数据</p>
<p>RDB、AOF两种持久化策略</p>
<h3 id="1、RDB的持久化策略：按照规则定时把数据同步到磁盘"><a href="#1、RDB的持久化策略：按照规则定时把数据同步到磁盘" class="headerlink" title="1、RDB的持久化策略：按照规则定时把数据同步到磁盘"></a>1、RDB的持久化策略：按照规则定时把数据同步到磁盘</h3><p>通过snapshot（快照）执行，redis在指定的情况下会触发快照</p>
<p>a) 自己配置的快照规则</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">##默认配置策略</span><br><span class="line">save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line">save <span class="number">900</span> <span class="number">1</span>  当在<span class="number">900</span>秒内被更改的key的数量大于<span class="number">1</span>的时候，就执行快照</span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line">以上三条规则是<span class="string">"或（||）"</span>的关系，满足其中一条时即可触发</span><br></pre></td></tr></table></figure>

<p>快照文件【dump.rdb】</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 program]<span class="meta"># cd redis</span></span><br><span class="line">[root@cs_ztb-server4 redis]<span class="meta"># cd bin</span></span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># ls</span></span><br><span class="line">dump.rdb  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br><span class="line">[root@cs_ztb-server4 bin]#</span><br></pre></td></tr></table></figure>

<p>b)  save或者bgsave</p>
<p>save ：执行内存的数据同步到磁盘的操作，这个操作会阻塞客户端的请求</p>
<p>bgsave：在后台异步执行快照操作，这个操作不会阻塞客户端请求</p>
<p>c)  执行flush的时候</p>
<p>清除内存的所有数据，只要快照的规则不为空，也就是第一个规则（a）存在，那么redis会执行快照</p>
<p>d)  执行复制的时候</p>
<p>快照的实现原理：</p>
<p>a）redis使用fork函数复制一份当前进程的副本（子进程），fork进程负责把内存的数据同步到磁盘的临时文件，父进程继续处理客户端请求</p>
<p>b）父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件</p>
<p>c）当子进程写入完所有数据后会用该临时文件替换旧的RDB文件，至此，一次快照操作完成</p>
<p>注意：redis在进行快照的过程中不会修改RDB文件，只有快照结束后才会将旧的文件替换成新的，也就是说任何时候RDB文件都是完整的。 这就使得我们可以通过定时备份RDB文件来实现redis数据库的备份， RDB文件是经过压缩的二进制文件，占用的空间会小于内存中的数据，更加利于传输。</p>
<p>RDB的优缺点</p>
<p>a）可能会存在数据丢失的请求（缺点）：使用RDB实现持久化，一旦redis异常退出，就会丢失最后一次快照以后更改的所有数据，这个时候我们就要根据具体的应用场景，通过组合设置自动快照的方式将可能发生的数据损失控制在能够接受的范围之内。如果数据相对比较重要，希望将损失降到最小，则可以使用AOF方式持久化</p>
<p>b） 可以最大化redis的性能（优点）：父进程在保存RDB文件时唯一要做的就是fork出一个子进程，然后由这个子进程就会处理接下来的所有保存工作，父进程无需执行任何磁盘I/O操作。同时这也是一个缺点，如果数据集比较大的时候，fork可能比较耗时（缺点），造成服务器在一段时间内停车处理客户端请求</p>
<p>RDB实践：</p>
<p>修改redis.conf中的appendonly yes ; 重启后执行对数据的变更命令，会在bin目录下生成对应的.aof文件， aof文件中会记录所有的操作命令</p>
<p>如下两个参数可以去对aof文件做优化</p>
<p>auto-aof-rewrite-percentage 100  表示当前aof文件大小超过上一次aof文件大小的百分之多少的时候会进行重写。如果之前没有重写过，以启动时aof文件大小为准</p>
<p>auto-aof-rewrite-min-size 64mb   限制允许重写最小aof文件大小，也就是文件大小小于64mb的时候，不需要进行优化</p>
<h3 id="2、AOF的持久化策略：每次执行命令后，把命令本身记录下来"><a href="#2、AOF的持久化策略：每次执行命令后，把命令本身记录下来" class="headerlink" title="2、AOF的持久化策略：每次执行命令后，把命令本身记录下来"></a>2、AOF的持久化策略：每次执行命令后，把命令本身记录下来</h3><p>AOF会将redis执行的每一条命令追加到磁盘文件中，这一过程显然会降低redis性能，大部分情况下是可以接受的，使用较快的硬盘（SSD）可以提高AOF性能。</p>
<p>AOF重写原理：</p>
<p>Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写： 重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。 整个重写操作是绝对安全的，因为Redis 在创建新 AOF 文件的过程中，会继续将命令追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。而一旦新 AOF 文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作。AOF 文件有序地保存了对数据库执行的所有写入操作，这些写入操作以 Redis 协议的格式保存， 因此 AOF 文件的内容非常容易被人读懂，对文件进行分析（parse）也很轻松</p>
<p>AOF同步磁盘数据</p>
<p>redis每次更改数据的时候， aof机制都会讲命令记录到aof文件，但是实际上由于操作系统的缓存机制，数据并没有实时写入到硬盘，而是进入硬盘缓存。再通过硬盘缓存机制去刷新到保存到文件</p>
<p># appendfsync always  每次执行写入都会进行同步  ， 这个是最安全但是是效率比较低的方式</p>
<p>appendfsync everysec   每一秒执行</p>
<p># appendfsync no 不主动进行同步操作，由操作系统去执行，这个是最快但是最不安全的方式</p>
<p>AOF文件损坏后如何修复</p>
<p>服务器可能在程序正在对 AOF 文件进行写入时停机， 如果停机造成了 AOF 文件出错（corrupt）， 那么 Redis 在重启时会拒绝载入这个 AOF 文件， 从而确保数据的一致性不会被破坏。</p>
<p>当发生这种情况时，可以用以下方法来修复出错的 AOF 文件：</p>
<ol>
<li><p>为现有的 AOF 文件创建一个备份。</p>
</li>
<li><p>使用 Redis 附带的 redis-check-aof 程序，对原来的 AOF 文件进行修复。</p>
</li>
</ol>
<p><strong>redis-check-aof –fix</strong> 重启 Redis 服务器，等待服务器载入修复后的 AOF 文件，并进行数据恢复。</p>
<p>AOF实践：</p>
<p>默认情况下Redis没有开启AOF（append onlyfile）方式的持久化，可以通过appendonly参数启用，在redis.conf中找到 appendonly yes开启AOF持久化后每执行一条会更改Redis中的数据的命令后，Redis就会将该命令写入硬盘中的AOF文件。AOF文件的保存位置和RDB文件的位置相同，都是通过dir参数设置的，默认的文件名是apendonly.aof. 可以在redis.conf中的属性 appendfilenameappendonlyh.aof修改</p>
<p>开启AOF，将【redis.conf】文件中设置”appendonly no”更改为”appendonly yes”，默认保存的文件名为”appendonly.aof”</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Please check http:<span class="comment">//redis.io/topics/persistence for more information.</span></span><br><span class="line">appendonly yes</span><br><span class="line"># <span class="function">The name of the append only <span class="title">file</span> <span class="params">(<span class="keyword">default</span>: <span class="string">"appendonly.aof"</span>)</span></span></span><br><span class="line">appendfilename "appendonly.aof"</span><br></pre></td></tr></table></figure>

<p>重启服务，更改IP供外网访问后，启动客户端命令【./redis-cli -h IP -p PORT】：”./redis-cli -h 172.16.38.224 -p 6379”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli </span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">connect</span> to Redis at <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>: Connection refused</span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">connect</span> to Redis at <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>: Connection refused</span><br><span class="line"><span class="keyword">not</span> <span class="built_in">connected</span>&gt; </span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli <span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span> <span class="number">6379</span></span><br><span class="line">Could <span class="keyword">not</span> <span class="built_in">connect</span> to Redis at <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>: Connection refused</span><br><span class="line">#正确命令</span><br><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli -h <span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span> -p <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>执行以下操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; FLUSHALL</span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key value</span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key value1</span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key <span class="number">1</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> key</span><br><span class="line"><span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<p>查询AOF保存的文件内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; </span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># ls</span></span><br><span class="line">dump.rdb  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br></pre></td></tr></table></figure>

<p>发现并无”apendonly.aof”文件，尝试java调用，代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.anjubao.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = RedisManager.getJedis();</span><br><span class="line">            String s = jedis.set(<span class="string">"test"</span>,<span class="string">"test111"</span>);</span><br><span class="line">            System.out.println(s);</span><br><span class="line">            String ss = jedis.get(<span class="string">"test"</span>);</span><br><span class="line">            System.out.println(ss);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行Operation，结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">test111</span><br></pre></td></tr></table></figure>

<p>再次查看”apendonly.aof”文件，发现仍未出现AOF文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># clear</span></span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># ls</span></span><br><span class="line">dump.rdb  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br></pre></td></tr></table></figure>

<p>进行以下操作，出现了”apendonly.aof”文件。错误原因未redis-server未正常重启，需关闭客户端后再次重启</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli -h <span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span> -p <span class="number">6379</span> <span class="built_in">shutdown</span></span><br><span class="line">[root@cs_ztb-server4 bin]<span class="meta"># ls</span></span><br><span class="line">appendonly.aof  dump.rdb  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br></pre></td></tr></table></figure>

<p>注意：启动客户端后发现 key 名称为”key”的值已经不存在了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cs_ztb-server4 bin]# ./redis-cli -h <span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span> -p <span class="number">6379</span> </span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> key</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure>

<p>再次执行修改操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> key</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key value</span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key value1</span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key <span class="number">1</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">172.16</span><span class="number">.38</span><span class="number">.224</span>:<span class="number">6379</span>&gt; <span class="built_in">get</span> key</span><br><span class="line"><span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<p>查看”apendonly.aof”文件内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">*<span class="number">2</span></span><br><span class="line">$<span class="number">6</span></span><br><span class="line">SELECT</span><br><span class="line">$<span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">*<span class="number">3</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line"><span class="built_in">set</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line">key</span><br><span class="line">$<span class="number">5</span></span><br><span class="line">value</span><br><span class="line">*<span class="number">3</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line"><span class="built_in">set</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line">key</span><br><span class="line">$<span class="number">6</span></span><br><span class="line">value1</span><br><span class="line">*<span class="number">3</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line"><span class="built_in">set</span></span><br><span class="line">$<span class="number">3</span></span><br><span class="line">key</span><br><span class="line">$<span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">~</span><br></pre></td></tr></table></figure>



<p>AOF优化：</p>
<p>修改redis.conf中的appendonly yes ; 重启后执行对数据的变更命令，会在bin目录下生成对应的.aof文件， aof文件中会记录所有的操作命令</p>
<p>如下两个参数可以去对aof文件做优化</p>
<p>auto-aof-rewrite-percentage 100  表示当前aof文件大小超过上一次aof文件大小的百分之多少的时候会进行重写。如果之前没有重写过，以启动时aof文件大小为准</p>
<p>auto-aof-rewrite-min-size 64mb   限制允许重写最小aof文件大小，也就是文件大小小于64mb的时候，不需要进行优化</p>
<h3 id="3、RDB、AOF两种持久化策略可以同时使用，也可以使用其中一种。如果同时使用的话，那么redis重启时，会优先使用AOF文件来还原数据"><a href="#3、RDB、AOF两种持久化策略可以同时使用，也可以使用其中一种。如果同时使用的话，那么redis重启时，会优先使用AOF文件来还原数据" class="headerlink" title="3、RDB、AOF两种持久化策略可以同时使用，也可以使用其中一种。如果同时使用的话，那么redis重启时，会优先使用AOF文件来还原数据"></a>3、RDB、AOF两种持久化策略可以同时使用，也可以使用其中一种。如果同时使用的话，那么redis重启时，会优先使用AOF文件来还原数据</h3><p>RDB、AOF如何选择：</p>
<p>一般来说,如果对数据的安全性要求非常高的话，应该同时使用两种持久化功能。如果可以承受数分钟以内的数据丢失，那么可以只使用 RDB 持久化。有很多用户都只使用 AOF 持久化， 但并不推荐这种方式：因为定时生成 RDB 快照（snapshot）非常便于进行数据库备份，并且 RDB 恢复数据集的速度也要比 AOF 恢复的速度要快 。</p>
<p><strong>两种持久化策略可以同时使用，也可以使用其中一种。如果同时使用的话，那么Redis重启时，会优先使用AOF文件来还原数据</strong></p>
<h2 id="十七、redis集群"><a href="#十七、redis集群" class="headerlink" title="十七、redis集群"></a>十七、redis集群</h2><p>复制（master、slave）</p>
<h3 id="1、配置过程："><a href="#1、配置过程：" class="headerlink" title="1、配置过程："></a>1、配置过程：</h3><p>修改192.168.11.140和192.168.11.141的redis.conf文件，增加slaveof masterip masterport</p>
<p>slaveof 192.168.11.138 6379</p>
<h3 id="2、实现原理"><a href="#2、实现原理" class="headerlink" title="2、实现原理"></a>2、实现原理</h3><p>2-1、slave第一次或者重连到master上以后，会向master发送一个SYNC的命令</p>
<p>2-2、master收到SYNC的时候，会做两件事</p>
<p>a)  执行bgsave（rdb的快照文件）</p>
<p>b)  master会把新收到的修改命令存入到缓冲区</p>
<p>缺点<br>没有办法对master进行动态选举</p>
<h3 id="3、复制方式"><a href="#3、复制方式" class="headerlink" title="3、复制方式"></a>3、复制方式</h3><p>3-1 、基于rdb文件的复制（第一次连接或者重连的时候）</p>
<p>3-2、 无硬盘复制</p>
<p>3-3、增量复制</p>
<p>PSYNC master run id. offset</p>
<h3 id="4、哨兵机制"><a href="#4、哨兵机制" class="headerlink" title="4、哨兵机制"></a>4、哨兵机制</h3><p>sentinel</p>
<p>4-1、 监控master和salve是否正常运行</p>
<p>4-2、 如果master出现故障，那么会把其中一台salve数据升级为master</p>
<h3 id="5、集群的原理"><a href="#5、集群的原理" class="headerlink" title="5、集群的原理"></a>5、集群的原理</h3><p>集群（redis3.0以后的功能）</p>
<p>根据key的hash值取模 服务器的数量 。 hash</p>
<p>Redis Cluster中，Sharding采用slot(槽)的概念，一共分成16384个槽，这有点儿类似前面讲的pre sharding思路。对于每个进入Redis的键值对，根据key进行散列，分配到这16384个slot中的某一个中。使用的hash算法也比较简单，就是CRC16后16384取模。Redis集群中的每个node(节点)负责分摊这16384个slot中的一部分，也就是说，每个slot都对应一个node负责处理。当动态添加或减少node节点时，需要将16384个槽做个再分配，槽中的键值也要迁移。当然，这一过程，在目前实现中，还处于半自动状态，需要人工介入。Redis集群，要保证16384个槽对应的node都正常工作，如果某个node发生故障，那它负责的slots也就失效，整个集群将不能工作。为了增加集群的可访问性，官方推荐的方案是将node配置成主从结构，即一个master主节点，挂n个slave从节点。这时，如果主节点失效，Redis Cluster会根据选举算法从slave节点中选择一个上升为主节点，整个集群继续对外提供服务。这非常类似服务器节点通过Sentinel监控架构成主从结构，只是Redis Cluster本身提供了故障转移容错的能力。</p>
<p>slot（槽）的概念，在redis集群中一共会有16384个槽，</p>
<p>根据key 的CRC16算法，得到的结果再对16384进行取模。假如有3个节点</p>
<p>node1  0 5460</p>
<p>node2  5461 10922</p>
<p>node3  10923 16383</p>
<p>节点新增</p>
<p>node4  0-1364,5461-6826,10923-12287</p>
<p>删除节点</p>
<p>先将节点的数据移动到其他节点上，然后才能执行删除</p>
<h2 id="十八、第三方提供的集群解决方案"><a href="#十八、第三方提供的集群解决方案" class="headerlink" title="十八、第三方提供的集群解决方案"></a>十八、第三方提供的集群解决方案</h2><p>1、 redis shardding  而且jedis客户端就支持shardding操作  SharddingJedis ； </p>
<p>​    增加和减少节点的问题； pre shardding</p>
<p>​    3台虚拟机 redis 。但是我部署了9个节点 。</p>
<p>​    每一台部署3个redis增加cpu的利用率9台虚拟机单独拆分到9台服务器</p>
<p>2、 codis基于redis2.8.13分支开发了一个codis-server</p>
<p>3、twemproxy twitter提供的开源解决方案</p>
<h2 id="十九、缓存击穿问题"><a href="#十九、缓存击穿问题" class="headerlink" title="十九、缓存击穿问题"></a>十九、缓存击穿问题</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://xiaozhiyh.github.io/2020/05/21/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Stephen Jiang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/21/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/" class="post-title-link" itemprop="url">分布式定时任务调度系统技术选型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-21 02:20:18 / Modified: 03:01:05" itemprop="dateCreated datePublished" datetime="2020-05-21T02:20:18+08:00">2020-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分布式定时任务调度系统技术选型"><a href="#分布式定时任务调度系统技术选型" class="headerlink" title="分布式定时任务调度系统技术选型"></a>分布式定时任务调度系统技术选型</h1><blockquote>
<p>作者：sharedCode</p>
<p>来源：<a href="https://blog.csdn.net/u012394095/article/details/79470904" target="_blank" rel="noopener">https://blog.csdn.net/u012394095/article/details/79470904</a></p>
</blockquote>
<h1 id="1-什么是分布式定时任务"><a href="#1-什么是分布式定时任务" class="headerlink" title="1. 什么是分布式定时任务"></a>1. 什么是分布式定时任务</h1><p>把分散的，可靠性差的计划任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。叫做分布式定时任务。</p>
<h1 id="2-常见开源方案"><a href="#2-常见开源方案" class="headerlink" title="2. 常见开源方案"></a>2. 常见开源方案</h1><ul>
<li>elastic-job</li>
<li>xxl-job</li>
<li>quartz</li>
<li>saturn</li>
<li>opencron</li>
<li>antares</li>
</ul>
<h2 id="elastic-job"><a href="#elastic-job" class="headerlink" title="elastic-job"></a>elastic-job</h2><p>elastic-job 是由当当网基于quartz 二次开发之后的分布式调度解决方案 ， 由两个相对独立的子项目Elastic-Job-Lite和Elastic-Job-Cloud组成 。</p>
<p>Elastic-Job-Lite定位为轻量级无中心化解决方案，使用jar包的形式提供分布式任务的协调服务。</p>
<p>Elastic-Job-Cloud使用Mesos + Docker(TBD)的解决方案，额外提供资源治理、应用分发以及进程隔离等服务</p>
<p>亮点：</p>
<ol>
<li>基于quartz 定时任务框架为基础的，因此具备quartz的大部分功能</li>
<li>使用zookeeper做协调，调度中心，更加轻量级</li>
<li>支持任务的分片</li>
<li>支持弹性扩容 ， 可以水平扩展 ， 当任务再次运行时，会检查当前的服务器数量，重新分片，分片结束之后才会继续执行任务</li>
<li>失效转移，容错处理，当一台调度服务器宕机或者跟zookeeper断开连接之后，会立即停止作业，然后再去寻找其他空闲的调度服务器，来运行剩余的任务</li>
<li>提供运维界面，可以管理作业和注册中心。</li>
</ol>
<p>elastic-job结合了quartz非常优秀的时间调度功能，并且利用ZooKeeper实现了灵活的分片策略。除此之外，还加入了大量实用的监控和管理功能，以及其开源社区活跃、文档齐全、代码优雅等优点，是分布式任务调度框架的推荐选择。</p>
<p>由于elastic-job-lite 不支持动态添加作业，此处仅贴上elastic-job-Cloud架构图</p>
<p><img src="/../../images/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/image-20200417233848873.png" alt="image-20200417233848873"></p>
<h2 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h2><p>由个人开源的一个轻量级分布式任务调度框架 ，主要分为 调度中心和执行器两部分 ， 调度中心在启动初始化的时候，会默认生成执行器的RPC代理</p>
<p>对象（http协议调用）， 执行器项目启动之后， 调度中心在触发定时器之后通过jobHandle 来调用执行器项目里面的代码，核心功能和elastic-job差不多，同时技术文档比较完善</p>
<p>系统架构图：</p>
<p><img src="/../../images/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/640.webp" alt="img"></p>
<h2 id="quartz"><a href="#quartz" class="headerlink" title="quartz"></a>quartz</h2><p>quartz 的常见集群方案如下，通过在数据库中配置定时器信息， 以数据库悲观锁的方式达到同一个任务始终只有一个节点在运行，</p>
<p>优点：</p>
<ol>
<li>保证节点高可用 （HA）， 如果某一个几点挂了， 其他节点可以顶上</li>
</ol>
<p>缺点：</p>
<ol>
<li>同一个任务只能有一个节点运行，其他节点将不执行任务，性能低，资源浪费</li>
<li>当碰到大量短任务时，各个节点频繁的竞争数据库锁，节点越多这种情况越严重。性能会很低下</li>
<li>quartz 的分布式仅解决了集群高可用的问题，并没有解决任务分片的问题，不能实现水平扩展</li>
</ol>
<p><img src="/../../images/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/image-20200417233807119.png" alt="image-20200417233807119"></p>
<h2 id="Saturn"><a href="#Saturn" class="headerlink" title="Saturn"></a>Saturn</h2><p>Saturn是唯品会在github开源的一款分布式任务调度产品。它是基于当当elastic-job 1.0版本来开发的，其上完善了一些功能和添加了一些新的feature。</p>
<p>亮点：</p>
<ol>
<li>支持多语言开发 python、Go、Shell、Java、Php。</li>
<li>管理控制台和数据统计分析更加完善</li>
</ol>
<p>缺点：</p>
<ol>
<li>技术文档较少 ， 该框架是2016年由唯品会的研发团队基于elastic-job开发而来的</li>
</ol>
<h2 id="opencron"><a href="#opencron" class="headerlink" title="opencron"></a>opencron</h2><p>一个功能完善真正通用的linux定时任务调度定系统,满足多种场景下各种复杂的定时任务调度,同时集成了linux实时监控,webssh,提供一个方便管理定时任务的平台</p>
<p>缺点：仅支持 kill任务， 现场执行，查询任务运行状态 等， 主要功能是着重于任务的修改和查询上。不能动态的添加任务以及任务分片。</p>
<h2 id="antares"><a href="#antares" class="headerlink" title="antares"></a>antares</h2><p>优点：</p>
<ol>
<li>一个任务仅会被服务器集群中的某个节点调度，调度机制基于成熟的 quartz</li>
<li>并行执行 ， 用户可通过对任务预分片，有效提升任务执行效率</li>
<li>失效转移</li>
<li>弹性扩容，在任务运行时，可以动态的加机器</li>
<li>友好的管理控制台</li>
</ol>
<p>缺点：</p>
<ol>
<li>不能动态的添加任务，仅能在控制台对任务进行触发，暂停，删除等操作</li>
<li>文档不多，开源社区不够活跃</li>
</ol>
<p>系统架构图如下：</p>
<p><img src="/../../images/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/640.png" alt="img"></p>
<h1 id="3-比较"><a href="#3-比较" class="headerlink" title="3. 比较"></a>3. 比较</h1><p>此处列出了几个代表性的开源产品</p>
<table>
<thead>
<tr>
<th align="left">feature</th>
<th align="left">quartz</th>
<th align="left">elastic-job-cloud</th>
<th align="left">xxl-job</th>
<th align="left">antares</th>
<th align="left">opencron</th>
</tr>
</thead>
<tbody><tr>
<td align="left">依赖</td>
<td align="left">mysql</td>
<td align="left">jdk1.7+, zookeeper 3.4.6+ ,maven3.0.4+ ,mesos</td>
<td align="left">mysql ,jdk1.7+ , maven3.0+</td>
<td align="left">jdk 1.7+ , redis , zookeeper</td>
<td align="left">jdk1.7+ , Tomcat8.0+</td>
</tr>
<tr>
<td align="left">HA</td>
<td align="left">多节点部署，通过竞争数据库锁来保证只有一个节点执行任务</td>
<td align="left">通过zookeeper的注册与发现，可以动态的添加服务器。支持水平扩容</td>
<td align="left">集群部署</td>
<td align="left">集群部署</td>
<td align="left">—</td>
</tr>
<tr>
<td align="left">任务分片</td>
<td align="left">—</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">—</td>
</tr>
<tr>
<td align="left">文档完善</td>
<td align="left">完善</td>
<td align="left">完善</td>
<td align="left">完善</td>
<td align="left">文档略少</td>
<td align="left">文档略少</td>
</tr>
<tr>
<td align="left">管理界面</td>
<td align="left">无</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
</tr>
<tr>
<td align="left">难易程度</td>
<td align="left">简单</td>
<td align="left">较复杂</td>
<td align="left">简单</td>
<td align="left">一般</td>
<td align="left">一般</td>
</tr>
<tr>
<td align="left">公司</td>
<td align="left">OpenSymphony</td>
<td align="left">当当网</td>
<td align="left">个人</td>
<td align="left">个人</td>
<td align="left">个人</td>
</tr>
<tr>
<td align="left">高级功能</td>
<td align="left">—</td>
<td align="left">弹性扩容，多种作业模式，失效转移，运行状态收集，多线程处理数据，幂等性，容错处理，spring命名空间支持</td>
<td align="left">弹性扩容，分片广播，故障转移，Rolling实时日志，GLUE（支持在线编辑代码，免发布）,任务进度监控，任务依赖，数据加密，邮件报警，运行报表，国际化</td>
<td align="left">任务分片， 失效转移，弹性扩容 ，</td>
<td align="left">时间规则支持quartz和crontab ，kill任务， 现场执行，查询任务运行状态</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">没有管理界面，以及不支持任务分片等。不适用于分布式场景</td>
<td align="left">需要引入zookeeper , mesos, 增加系统复杂度, 学习成本较高</td>
<td align="left">调度中心通过获取 DB锁来保证集群中执行任务的唯一性， 如果短任务很多，随着调度中心集群数量增加，那么数据库的锁竞争会比较厉害，性能不好。</td>
<td align="left">不支持动态添加任务</td>
<td align="left">不适用于分布式场景</td>
</tr>
<tr>
<td align="left">使用企业</td>
<td align="left">大众化产品，对分布式调度要求不高的公司大面积使用</td>
<td align="left">36氪，当当网，国美，金柚网，联想，唯品会，亚信，平安，猪八戒</td>
<td align="left">大众点评，运满满，优信二手车，拍拍贷</td>
<td align="left">—</td>
<td align="left">—</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://xiaozhiyh.github.io/2020/05/20/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Stephen Jiang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/20/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-20 01:20:41 / Modified: 02:00:52" itemprop="dateCreated datePublished" datetime="2020-05-20T01:20:41+08:00">2020-05-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Hello-Hexo"><a href="#Hello-Hexo" class="headerlink" title="Hello Hexo"></a>Hello Hexo</h2><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Stephen Jiang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stephen Jiang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
